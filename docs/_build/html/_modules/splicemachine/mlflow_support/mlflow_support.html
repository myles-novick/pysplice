
<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>splicemachine.mlflow_support.mlflow_support &#8212; Splice MLManager  documentation</title>
    
  <link href="../../../_static/css/theme.css" rel="stylesheet" />
  <link href="../../../_static/css/index.c5995385ac14fb8791e8eb36b4908be2.css" rel="stylesheet" />

    
  <link rel="stylesheet"
    href="../../../_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../../../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../../../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    
      

    
    <link rel="stylesheet" href="../../../_static/sphinx-book-theme.acff12b8f9c144ce68a297486a2fa670.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/sphinx_tabs/semantic-ui-2.4.1/segment.min.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/sphinx_tabs/semantic-ui-2.4.1/menu.min.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/sphinx_tabs/semantic-ui-2.4.1/tab.min.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/sphinx_tabs/tabs.css" />
    
  <link rel="preload" as="script" href="../../../_static/js/index.1c5a1a01449ed65a7b51.js">

    <script id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
    <script src="../../../_static/jquery.js"></script>
    <script src="../../../_static/underscore.js"></script>
    <script src="../../../_static/doctools.js"></script>
    <script src="../../../_static/language_data.js"></script>
    <script src="../../../_static/sphinx_tabs/semantic-ui-2.4.1/tab.min.js"></script>
    <script src="../../../_static/sphinx_tabs/tabs.js"></script>
    <script src="../../../_static/sphinx-book-theme.12a9622fbb08dcb3a2a40b2c02b83a57.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="en" />
    
  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="80">
    
    <div class="container-fluid" id="banner"></div>

    

    <div class="container-xl">
      <div class="row">
          
<div class="col-12 col-md-3 bd-sidebar site-navigation show" id="site-navigation">
    
        <div class="navbar-brand-box">
    <a class="navbar-brand text-wrap" href="../../../index.html">
      
      
      <h1 class="site-logo" id="site-title">Splice MLManager  documentation</h1>
      
    </a>
</div><form class="bd-search d-flex align-items-center" action="../../../search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search the docs ..." aria-label="Search the docs ..." autocomplete="off" >
</form><nav class="bd-links" id="bd-docs-nav" aria-label="Main navigation">
    <div class="bd-toc-item active">
        <p class="caption">
 <span class="caption-text">
  Contents:
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../../../getting-started.html">
   Getting Started
  </a>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../../../splicemachine.html">
   Splicemachine package
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" type="checkbox"/>
  <label for="toctree-checkbox-1">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../splicemachine.spark.html">
     splicemachine.spark package
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../splicemachine.mlflow_support.html">
     splicemachine.mlflow_support package
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../splicemachine.features.html">
     splicemachine.features package
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../splicemachine.notebook.html">
     splicemachine.notebook module
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../splicemachine.stats.html">
     splicemachine.stats module
    </a>
   </li>
  </ul>
 </li>
</ul>

    </div>
</nav> <!-- To handle the deprecated key -->

<div class="navbar_extra_footer">
  Theme by the <a href="https://ebp.jupyterbook.org">Executable Book Project</a>
</div>

</div>


          


          
<main class="col py-md-3 pl-md-4 bd-content overflow-auto" role="main">
    
    <div class="topbar container-xl fixed-top">
    <div class="topbar-contents row">
        <div class="col-12 col-md-3 bd-topbar-whitespace site-navigation show"></div>
        <div class="col pl-md-4 topbar-main">
            
            <button id="navbar-toggler" class="navbar-toggler ml-0" type="button" data-toggle="collapse"
                data-toggle="tooltip" data-placement="bottom" data-target=".site-navigation" aria-controls="navbar-menu"
                aria-expanded="true" aria-label="Toggle navigation" aria-controls="site-navigation"
                title="Toggle navigation" data-toggle="tooltip" data-placement="left">
                <i class="fas fa-bars"></i>
                <i class="fas fa-arrow-left"></i>
                <i class="fas fa-arrow-up"></i>
            </button>
            
            
            <!-- Source interaction buttons -->

            <!-- Full screen (wrap in <a> to have style consistency -->

<a class="full-screen-button"><button type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip"
        data-placement="bottom" onclick="toggleFullScreen()" aria-label="Fullscreen mode"
        title="Fullscreen mode"><i
            class="fas fa-expand"></i></button></a>

            <!-- Launch buttons -->

        </div>

        <!-- Table of contents -->
        <div class="d-none d-md-block col-md-2 bd-toc show">
            
        </div>
    </div>
</div>
    <div id="main-content" class="row">
        <div class="col-12 col-md-9 pl-md-3 pr-md-0">
        
              <div>
                
  <h1>Source code for splicemachine.mlflow_support.mlflow_support</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Copyright 2020 Splice Machine, Inc.</span>

<span class="sd">Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</span>
<span class="sd">you may not use this file except in compliance with the License.</span>
<span class="sd">You may obtain a copy of the License at</span>

<span class="sd">    http://www.apache.org/licenses/LICENSE-2.0</span>

<span class="sd">Unless required by applicable law or agreed to in writing, software</span>
<span class="sd">distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span>
<span class="sd">WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span>
<span class="sd">See the License for the specific language governing permissions and</span>
<span class="sd">limitations under the License.\n</span>

<span class="sd">======================================================================================================================================================================================\n</span>

<span class="sd">All functions in this module are accessible through the mlflow object and are to be referenced without the leading underscore as \n</span>
<span class="sd">.. code-block:: python</span>

<span class="sd">    mlflow.function_name()</span>

<span class="sd">For example, the function _current_exp_id() is accessible via\n</span>
<span class="sd">.. code-block:: python</span>

<span class="sd">    mlflow.current_exp_id()</span>


<span class="sd">All functions are accessible after running the following import\n</span>
<span class="sd">.. code-block:: python</span>

<span class="sd">    from splicemachine.mlflow_support import *</span>

<span class="sd">Importing anything directly from mlflow before running the above statement will cause problems. After running the above import, you can import additional mlflow submodules as normal\n</span>
<span class="sd">.. code-block:: python</span>

<span class="sd">    from splicemachine.mlflow_support import *</span>
<span class="sd">    from mlflow.tensorflow import autolog</span>

<span class="sd">======================================================================================================================================================================================\n</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">import</span> <span class="nn">glob</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">copy</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">defaultdict</span>
<span class="kn">from</span> <span class="nn">contextlib</span> <span class="kn">import</span> <span class="n">contextmanager</span>
<span class="kn">from</span> <span class="nn">importlib</span> <span class="kn">import</span> <span class="n">import_module</span>
<span class="kn">from</span> <span class="nn">io</span> <span class="kn">import</span> <span class="n">BytesIO</span>
<span class="kn">from</span> <span class="nn">os</span> <span class="kn">import</span> <span class="n">path</span>
<span class="kn">from</span> <span class="nn">sys</span> <span class="kn">import</span> <span class="n">version</span> <span class="k">as</span> <span class="n">py_version</span><span class="p">,</span> <span class="n">stderr</span>
<span class="kn">from</span> <span class="nn">tempfile</span> <span class="kn">import</span> <span class="n">TemporaryDirectory</span><span class="p">,</span> <span class="n">NamedTemporaryFile</span>
<span class="kn">from</span> <span class="nn">zipfile</span> <span class="kn">import</span> <span class="n">ZIP_DEFLATED</span><span class="p">,</span> <span class="n">ZipFile</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Union</span>

<span class="kn">import</span> <span class="nn">gorilla</span>
<span class="kn">import</span> <span class="nn">h2o</span>
<span class="kn">import</span> <span class="nn">mlflow</span>
<span class="kn">import</span> <span class="nn">mlflow.pyfunc</span>
<span class="kn">from</span> <span class="nn">mlflow.tracking.fluent</span> <span class="kn">import</span> <span class="n">ActiveRun</span>
<span class="kn">from</span> <span class="nn">mlflow.entities</span> <span class="kn">import</span> <span class="n">RunStatus</span>
<span class="kn">import</span> <span class="nn">pyspark</span>
<span class="kn">import</span> <span class="nn">requests</span>
<span class="kn">import</span> <span class="nn">sklearn</span>
<span class="kn">import</span> <span class="nn">yaml</span>
<span class="kn">import</span> <span class="nn">warnings</span>

<span class="kn">from</span> <span class="nn">pandas.core.frame</span> <span class="kn">import</span> <span class="n">DataFrame</span> <span class="k">as</span> <span class="n">PandasDF</span>
<span class="kn">from</span> <span class="nn">pyspark.ml.base</span> <span class="kn">import</span> <span class="n">Model</span> <span class="k">as</span> <span class="n">SparkModel</span>
<span class="kn">from</span> <span class="nn">pyspark.sql</span> <span class="kn">import</span> <span class="n">DataFrame</span> <span class="k">as</span> <span class="n">SparkDF</span>
<span class="kn">from</span> <span class="nn">requests.auth</span> <span class="kn">import</span> <span class="n">HTTPBasicAuth</span>
<span class="kn">from</span> <span class="nn">sklearn.base</span> <span class="kn">import</span> <span class="n">BaseEstimator</span> <span class="k">as</span> <span class="n">ScikitModel</span>

<span class="kn">from</span> <span class="nn">splicemachine.features</span> <span class="kn">import</span> <span class="n">FeatureStore</span>
<span class="kn">from</span> <span class="nn">splicemachine.mlflow_support.constants</span> <span class="kn">import</span> <span class="p">(</span><span class="n">FileExtensions</span><span class="p">,</span> <span class="n">DatabaseSupportedLibs</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">splicemachine.mlflow_support.utilities</span> <span class="kn">import</span> <span class="p">(</span><span class="n">SparkUtils</span><span class="p">,</span> <span class="n">get_pod_uri</span><span class="p">,</span> <span class="n">get_user</span><span class="p">,</span>
                                                    <span class="n">insert_artifact</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">splicemachine</span> <span class="kn">import</span> <span class="n">SpliceMachineException</span>
<span class="kn">from</span> <span class="nn">splicemachine.spark.context</span> <span class="kn">import</span> <span class="n">PySpliceContext</span>

<span class="k">try</span><span class="p">:</span> <span class="c1"># PySpark/H2O 3.X</span>
    <span class="kn">from</span> <span class="nn">h2o.model.model_base</span> <span class="kn">import</span> <span class="n">ModelBase</span> <span class="k">as</span> <span class="n">H2OModel</span>
<span class="k">except</span><span class="p">:</span> <span class="c1"># PySpark/H2O 2.X</span>
    <span class="kn">from</span> <span class="nn">h2o.estimators.estimator_base</span> <span class="kn">import</span> <span class="n">ModelBase</span> <span class="k">as</span> <span class="n">H2OModel</span>

<span class="c1"># For recording notebook history</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">IPython</span> <span class="kn">import</span> <span class="n">get_ipython</span>
    <span class="kn">import</span> <span class="nn">nbformat</span> <span class="k">as</span> <span class="nn">nbf</span>
    <span class="n">ipython</span> <span class="o">=</span> <span class="n">get_ipython</span><span class="p">()</span>
    <span class="n">mlflow</span><span class="o">.</span><span class="n">_notebook_history</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="n">ipython</span><span class="p">)</span> <span class="c1"># If running outside a notebook/ipython, this will be False</span>
<span class="k">except</span><span class="p">:</span>
    <span class="n">mlflow</span><span class="o">.</span><span class="n">_notebook_history</span> <span class="o">=</span> <span class="kc">False</span>

<span class="n">_TESTING</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;TESTING&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>

<span class="k">try</span><span class="p">:</span>
    <span class="n">_TRACKING_URL</span> <span class="o">=</span> <span class="n">get_pod_uri</span><span class="p">(</span><span class="s2">&quot;mlflow&quot;</span><span class="p">,</span> <span class="s2">&quot;5001&quot;</span><span class="p">,</span> <span class="n">_TESTING</span><span class="p">)</span>
<span class="k">except</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;It looks like you&#39;re running outside the Splice K8s Cloud Service. &quot;</span>
          <span class="s2">&quot;You must run mlflow.set_mlflow_uri(&lt;url&gt;) and pass in the URL to the MLFlow UI&quot;</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">stderr</span><span class="p">)</span>
    <span class="n">_TRACKING_URL</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>

<span class="n">_CLIENT</span> <span class="o">=</span> <span class="n">mlflow</span><span class="o">.</span><span class="n">tracking</span><span class="o">.</span><span class="n">MlflowClient</span><span class="p">(</span><span class="n">tracking_uri</span><span class="o">=</span><span class="n">_TRACKING_URL</span><span class="p">)</span>
<span class="n">mlflow</span><span class="o">.</span><span class="n">client</span> <span class="o">=</span> <span class="n">_CLIENT</span>

<span class="n">_GORILLA_SETTINGS</span> <span class="o">=</span> <span class="n">gorilla</span><span class="o">.</span><span class="n">Settings</span><span class="p">(</span><span class="n">allow_hit</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">store_hit</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">_PYTHON_VERSION</span> <span class="o">=</span> <span class="n">py_version</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;|&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>

<div class="viewcode-block" id="SpliceActiveRun"><a class="viewcode-back" href="../../../splicemachine.mlflow_support.html#splicemachine.mlflow_support.mlflow_support.SpliceActiveRun">[docs]</a><span class="k">class</span> <span class="nc">SpliceActiveRun</span><span class="p">(</span><span class="n">ActiveRun</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A wrapped active run for Splice Machine that calls our custom mlflow.end_run, so we can record the notebook</span>
<span class="sd">    history</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__exit__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exc_type</span><span class="p">,</span> <span class="n">exc_val</span><span class="p">,</span> <span class="n">exc_tb</span><span class="p">):</span>
        <span class="n">status</span> <span class="o">=</span> <span class="n">RunStatus</span><span class="o">.</span><span class="n">FINISHED</span> <span class="k">if</span> <span class="n">exc_type</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">RunStatus</span><span class="o">.</span><span class="n">FAILED</span>
        <span class="n">mlflow</span><span class="o">.</span><span class="n">end_run</span><span class="p">(</span><span class="n">RunStatus</span><span class="o">.</span><span class="n">to_string</span><span class="p">(</span><span class="n">status</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">exc_type</span> <span class="ow">is</span> <span class="kc">None</span></div>

<span class="k">def</span> <span class="nf">__try_auto_login</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Tries to login the user to the Director for deployment automatically. This will only work if the user is not</span>
<span class="sd">    using the cloud service.</span>

<span class="sd">    :return: None</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">jwt</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;SPLICE_JUPYTER_JWTTOKEN&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">jwt</span><span class="p">:</span>
        <span class="n">mlflow</span><span class="o">.</span><span class="n">login_director</span><span class="p">(</span><span class="n">jwt_token</span><span class="o">=</span><span class="n">jwt</span><span class="p">)</span>
    <span class="n">user</span><span class="p">,</span> <span class="n">password</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;SPLICE_JUPYTER_USER&#39;</span><span class="p">),</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;SPLICE_JUPYTER_PASSWORD&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">user</span> <span class="ow">and</span> <span class="n">password</span><span class="p">:</span>
        <span class="n">mlflow</span><span class="o">.</span><span class="n">login_director</span><span class="p">(</span><span class="n">username</span><span class="o">=</span><span class="n">user</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="n">password</span><span class="p">)</span>

<div class="viewcode-block" id="_mlflow_patch"><a class="viewcode-back" href="../../../splicemachine.mlflow_support.html#splicemachine.mlflow_support.mlflow_support._mlflow_patch">[docs]</a><span class="k">def</span> <span class="nf">_mlflow_patch</span><span class="p">(</span><span class="n">name</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Create a MLFlow Patch that applies the default gorilla settings</span>

<span class="sd">    :param name: destination name under mlflow package</span>
<span class="sd">    :return: decorator for patched function</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">gorilla</span><span class="o">.</span><span class="n">patch</span><span class="p">(</span><span class="n">mlflow</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">settings</span><span class="o">=</span><span class="n">_GORILLA_SETTINGS</span><span class="p">)</span></div>


<div class="viewcode-block" id="_get_current_run_data"><a class="viewcode-back" href="../../../splicemachine.mlflow_support.html#splicemachine.mlflow_support.mlflow_support._get_current_run_data">[docs]</a><span class="k">def</span> <span class="nf">_get_current_run_data</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get the data associated with the current run.</span>
<span class="sd">    As of MLFLow 1.6, it currently does not support getting run info from the mlflow.active_run object, so we need it</span>
<span class="sd">    to be retrieved via the tracking client.</span>

<span class="sd">    :return: active run data object</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">_CLIENT</span><span class="o">.</span><span class="n">get_run</span><span class="p">(</span><span class="n">mlflow</span><span class="o">.</span><span class="n">active_run</span><span class="p">()</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">run_id</span><span class="p">)</span><span class="o">.</span><span class="n">data</span></div>

<div class="viewcode-block" id="__get_active_user"><a class="viewcode-back" href="../../../splicemachine.mlflow_support.html#splicemachine.mlflow_support.mlflow_support.__get_active_user">[docs]</a><span class="k">def</span> <span class="nf">__get_active_user</span><span class="p">():</span>
    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">mlflow</span><span class="p">,</span> <span class="s1">&#39;_username&#39;</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">mlflow</span><span class="o">.</span><span class="n">_username</span>
    <span class="k">if</span> <span class="n">get_user</span><span class="p">():</span>
        <span class="k">return</span> <span class="n">get_user</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">SpliceMachineException</span><span class="p">(</span><span class="s2">&quot;Could not detect active user. Please run mlflow.login_director() and pass in your Splice&quot;</span>
                                  <span class="s2">&quot;username and password or JWT token.&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="_get_run_ids_by_name"><a class="viewcode-back" href="../../../splicemachine.mlflow_support.html#splicemachine.mlflow_support.mlflow_support._get_run_ids_by_name">[docs]</a><span class="nd">@_mlflow_patch</span><span class="p">(</span><span class="s1">&#39;get_run_ids_by_name&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">_get_run_ids_by_name</span><span class="p">(</span><span class="n">run_name</span><span class="p">,</span> <span class="n">experiment_id</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Gets a run id from the run name. If there are multiple runs with the same name, all run IDs are returned</span>

<span class="sd">    :param run_name: (str) The name of the run</span>
<span class="sd">    :param experiment_id: (int) The experiment to search in. If None, all experiments are searched. [Default None]</span>
<span class="sd">    :return: (List[str]) List of run ids</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">exps</span> <span class="o">=</span> <span class="p">[</span><span class="n">_CLIENT</span><span class="o">.</span><span class="n">get_experiment</span><span class="p">(</span><span class="n">experiment_id</span><span class="p">)]</span> <span class="k">if</span> <span class="n">experiment_id</span> <span class="k">else</span> <span class="n">_CLIENT</span><span class="o">.</span><span class="n">list_experiments</span><span class="p">()</span>
    <span class="n">run_ids</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">exp</span> <span class="ow">in</span> <span class="n">exps</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">run</span> <span class="ow">in</span> <span class="n">_CLIENT</span><span class="o">.</span><span class="n">search_runs</span><span class="p">(</span><span class="n">exp</span><span class="o">.</span><span class="n">experiment_id</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">run_name</span> <span class="o">==</span> <span class="n">run</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">tags</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;mlflow.runName&#39;</span><span class="p">):</span>
                <span class="n">run_ids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">run</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">tags</span><span class="p">[</span><span class="s1">&#39;Run ID&#39;</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">run_ids</span></div>

<div class="viewcode-block" id="_register_splice_context"><a class="viewcode-back" href="../../../splicemachine.mlflow_support.html#splicemachine.mlflow_support.mlflow_support._register_splice_context">[docs]</a><span class="nd">@_mlflow_patch</span><span class="p">(</span><span class="s1">&#39;register_splice_context&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">_register_splice_context</span><span class="p">(</span><span class="n">splice_context</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Register a Splice Context for Spark/Database operations (artifact storage, for example)</span>

<span class="sd">    :param splice_context: (PySpliceContext) splice context to input</span>
<span class="sd">    :return: None</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">splice_context</span><span class="p">,</span> <span class="n">PySpliceContext</span><span class="p">),</span> <span class="s2">&quot;You must pass in a PySpliceContext to this method&quot;</span>
    <span class="n">mlflow</span><span class="o">.</span><span class="n">_splice_context</span> <span class="o">=</span> <span class="n">splice_context</span></div>

<div class="viewcode-block" id="_register_feature_store"><a class="viewcode-back" href="../../../splicemachine.mlflow_support.html#splicemachine.mlflow_support.mlflow_support._register_feature_store">[docs]</a><span class="nd">@_mlflow_patch</span><span class="p">(</span><span class="s1">&#39;register_feature_store&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">_register_feature_store</span><span class="p">(</span><span class="n">fs</span><span class="p">:</span> <span class="n">FeatureStore</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Register a feature store for feature tracking of experiments</span>

<span class="sd">    :param feature_store: (FeatureStore) The feature store</span>
<span class="sd">    :return: None</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">mlflow</span><span class="o">.</span><span class="n">_feature_store</span> <span class="o">=</span> <span class="n">fs</span>
    <span class="n">mlflow</span><span class="o">.</span><span class="n">_feature_store</span><span class="o">.</span><span class="n">mlflow_ctx</span> <span class="o">=</span> <span class="n">mlflow</span></div>

<span class="k">def</span> <span class="nf">_check_for_splice_ctx</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Check to make sure that the user has registered</span>
<span class="sd">    a PySpliceContext with the mlflow object before allowing</span>
<span class="sd">    spark operations to take place</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">mlflow</span><span class="p">,</span> <span class="s1">&#39;_splice_context&#39;</span><span class="p">):</span>
        <span class="k">raise</span> <span class="n">SpliceMachineException</span><span class="p">(</span>
            <span class="s2">&quot;You must run `mlflow.register_splice_context(pysplice_context) before &quot;</span>
            <span class="s2">&quot;you can run this mlflow operation!&quot;</span>
        <span class="p">)</span>


<div class="viewcode-block" id="_current_run_id"><a class="viewcode-back" href="../../../splicemachine.mlflow_support.html#splicemachine.mlflow_support.mlflow_support._current_run_id">[docs]</a><span class="nd">@_mlflow_patch</span><span class="p">(</span><span class="s1">&#39;current_run_id&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">_current_run_id</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Retrieve the current run id</span>

<span class="sd">    :return: (str) the current run id</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">mlflow</span><span class="o">.</span><span class="n">active_run</span><span class="p">()</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">run_uuid</span></div>


<div class="viewcode-block" id="_current_exp_id"><a class="viewcode-back" href="../../../splicemachine.mlflow_support.html#splicemachine.mlflow_support.mlflow_support._current_exp_id">[docs]</a><span class="nd">@_mlflow_patch</span><span class="p">(</span><span class="s1">&#39;current_exp_id&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">_current_exp_id</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Retrieve the current exp id</span>

<span class="sd">    :return: (int) the current experiment id</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">mlflow</span><span class="o">.</span><span class="n">active_run</span><span class="p">()</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">experiment_id</span></div>


<div class="viewcode-block" id="_lp"><a class="viewcode-back" href="../../../splicemachine.mlflow_support.html#splicemachine.mlflow_support.mlflow_support._lp">[docs]</a><span class="nd">@_mlflow_patch</span><span class="p">(</span><span class="s1">&#39;lp&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">_lp</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Add a shortcut for logging parameters in MLFlow.</span>

<span class="sd">    :param key: (str) key for the parameter</span>
<span class="sd">    :param value: (str) value for the parameter</span>
<span class="sd">    :return: None</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">))</span> <span class="o">&gt;</span> <span class="mi">250</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">key</span><span class="p">))</span> <span class="o">&gt;</span> <span class="mi">250</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">SpliceMachineException</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;It seems your parameter input is too long. The max length is 250 characters.&#39;</span>
                                     <span class="sa">f</span><span class="s1">&#39;Your key is length </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">key</span><span class="p">))</span><span class="si">}</span><span class="s1"> and your value is length </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">))</span><span class="si">}</span><span class="s1">.&#39;</span><span class="p">)</span>
    <span class="n">mlflow</span><span class="o">.</span><span class="n">log_param</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span></div>


<div class="viewcode-block" id="_lm"><a class="viewcode-back" href="../../../splicemachine.mlflow_support.html#splicemachine.mlflow_support.mlflow_support._lm">[docs]</a><span class="nd">@_mlflow_patch</span><span class="p">(</span><span class="s1">&#39;lm&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">_lm</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">step</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Add a shortcut for logging metrics in MLFlow.</span>

<span class="sd">    :param key: (str) key for the parameter</span>
<span class="sd">    :param value: (str or int) value for the parameter</span>
<span class="sd">    :param step: (int) A single integer step at which to log the specified Metrics. If unspecified, each metric is logged at step zero.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">key</span><span class="p">))</span> <span class="o">&gt;</span> <span class="mi">250</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">SpliceMachineException</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;It seems your metric key is too long. The max length is 250 characters,&#39;</span>
                                     <span class="sa">f</span><span class="s1">&#39;but yours is </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">key</span><span class="p">))</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">mlflow</span><span class="o">.</span><span class="n">log_metric</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">step</span><span class="o">=</span><span class="n">step</span><span class="p">)</span></div>


<div class="viewcode-block" id="__get_serialized_mlmodel"><a class="viewcode-back" href="../../../splicemachine.mlflow_support.html#splicemachine.mlflow_support.mlflow_support.__get_serialized_mlmodel">[docs]</a><span class="k">def</span> <span class="nf">__get_serialized_mlmodel</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">model_lib</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">flavor_options</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Populate the Zip buffer with the serialized MLModel</span>
<span class="sd">    :param model: (Model) is the trained Spark/SKlearn/H2O/Keras model</span>
<span class="sd">          with the current run</span>
<span class="sd">    :param flavor_options: The extra kw arguments to any particular model library. If this is set, model_lib must be set</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">buffer</span> <span class="o">=</span> <span class="n">BytesIO</span><span class="p">()</span>
    <span class="n">zip_buffer</span> <span class="o">=</span> <span class="n">ZipFile</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;a&quot;</span><span class="p">,</span> <span class="n">compression</span><span class="o">=</span><span class="n">ZIP_DEFLATED</span><span class="p">,</span> <span class="n">allowZip64</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="k">with</span> <span class="n">TemporaryDirectory</span><span class="p">()</span> <span class="k">as</span> <span class="n">tempdir</span><span class="p">:</span>
        <span class="n">mlmodel_dir</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">tempdir</span><span class="si">}</span><span class="s1">/model&#39;</span>
        <span class="k">if</span> <span class="n">model_lib</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="kn">import</span> <span class="nn">mlflow</span>
                <span class="n">import_module</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;mlflow.</span><span class="si">{</span><span class="n">model_lib</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">model_lib</span> <span class="o">==</span> <span class="s1">&#39;pyfunc&#39;</span><span class="p">:</span>
                    <span class="nb">getattr</span><span class="p">(</span><span class="n">mlflow</span><span class="p">,</span> <span class="n">model_lib</span><span class="p">)</span><span class="o">.</span><span class="n">save_model</span><span class="p">(</span><span class="n">python_model</span><span class="o">=</span><span class="n">model</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="n">mlmodel_dir</span><span class="p">,</span> <span class="o">**</span><span class="n">flavor_options</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="nb">getattr</span><span class="p">(</span><span class="n">mlflow</span><span class="p">,</span> <span class="n">model_lib</span><span class="p">)</span><span class="o">.</span><span class="n">save_model</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="n">mlmodel_dir</span><span class="p">,</span> <span class="o">**</span><span class="n">flavor_options</span><span class="p">)</span>

                <span class="n">file_ext</span> <span class="o">=</span> <span class="n">FileExtensions</span><span class="o">.</span><span class="n">map_from_mlflow_flavor</span><span class="p">(</span><span class="n">model_lib</span><span class="p">)</span> <span class="k">if</span> \
                    <span class="n">model_lib</span> <span class="ow">in</span> <span class="n">DatabaseSupportedLibs</span><span class="o">.</span><span class="n">get_valid</span><span class="p">()</span> <span class="k">else</span> <span class="n">model_lib</span>

            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
                <span class="k">raise</span> <span class="n">SpliceMachineException</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Failed to save model type </span><span class="si">{</span><span class="n">model_lib</span><span class="si">}</span><span class="s1">. Ensure that is a supposed model &#39;</span>
                                             <span class="sa">f</span><span class="s1">&#39;flavor https://www.mlflow.org/docs/1.8.0/models.html#built-in-model-flavors</span><span class="se">\n</span><span class="s1">&#39;</span>
                                             <span class="sa">f</span><span class="s1">&#39;Or you can build a pyfunc model</span><span class="se">\n</span><span class="s1">&#39;</span>
                                             <span class="s1">&#39;https://www.mlflow.org/docs/1.8.0/models.html#python-function-python-function&#39;</span><span class="p">)</span>
        <span class="c1"># deprecated behavior</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">H2OModel</span><span class="p">):</span>
            <span class="kn">import</span> <span class="nn">mlflow.h2o</span>
            <span class="n">mlflow</span><span class="o">.</span><span class="n">set_tag</span><span class="p">(</span><span class="s1">&#39;splice.h2o_version&#39;</span><span class="p">,</span> <span class="n">h2o</span><span class="o">.</span><span class="n">__version__</span><span class="p">)</span>
            <span class="n">mlflow</span><span class="o">.</span><span class="n">h2o</span><span class="o">.</span><span class="n">save_model</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">mlmodel_dir</span><span class="p">,</span> <span class="o">**</span><span class="n">flavor_options</span><span class="p">)</span>
            <span class="n">file_ext</span> <span class="o">=</span> <span class="n">FileExtensions</span><span class="o">.</span><span class="n">h2o</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">SparkModel</span><span class="p">):</span>
            <span class="kn">import</span> <span class="nn">mlflow.spark</span>
            <span class="n">mlflow</span><span class="o">.</span><span class="n">set_tag</span><span class="p">(</span><span class="s1">&#39;splice.spark_version&#39;</span><span class="p">,</span> <span class="n">pyspark</span><span class="o">.</span><span class="n">__version__</span><span class="p">)</span>
            <span class="n">mlflow</span><span class="o">.</span><span class="n">spark</span><span class="o">.</span><span class="n">save_model</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">mlmodel_dir</span><span class="p">,</span> <span class="o">**</span><span class="n">flavor_options</span><span class="p">)</span>
            <span class="n">file_ext</span> <span class="o">=</span> <span class="n">FileExtensions</span><span class="o">.</span><span class="n">spark</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">ScikitModel</span><span class="p">):</span>
            <span class="kn">import</span> <span class="nn">mlflow.sklearn</span>
            <span class="n">mlflow</span><span class="o">.</span><span class="n">set_tag</span><span class="p">(</span><span class="s1">&#39;splice.sklearn_version&#39;</span><span class="p">,</span> <span class="n">sklearn</span><span class="o">.</span><span class="n">__version__</span><span class="p">)</span>
            <span class="n">mlflow</span><span class="o">.</span><span class="n">sklearn</span><span class="o">.</span><span class="n">save_model</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">mlmodel_dir</span><span class="p">,</span> <span class="o">**</span><span class="n">flavor_options</span><span class="p">)</span>
            <span class="n">file_ext</span> <span class="o">=</span> <span class="n">FileExtensions</span><span class="o">.</span><span class="n">sklearn</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">SpliceMachineException</span><span class="p">(</span><span class="s1">&#39;Model type not supported for logging. If you received this error,&#39;</span>
                                         <span class="s1">&#39;you should pass a value to the model_lib parameter of the model type you &#39;</span>
                                         <span class="s1">&#39;want to save, or call the original mlflow.&lt;flavor&gt;.log_model(). &#39;</span>
                                         <span class="s1">&#39;Supported values are available here: &#39;</span>
                                         <span class="s1">&#39;https://www.mlflow.org/docs/1.8.0/models.html#built-in-model-flavors</span><span class="se">\n</span><span class="s1">&#39;</span>
                                         <span class="s1">&#39;as well as </span><span class="se">\&#39;</span><span class="s1">pyfunc</span><span class="se">\&#39;</span><span class="s1"> &#39;</span>
                                         <span class="s1">&#39;https://www.mlflow.org/docs/1.8.0/models.html#python-function-python-function&#39;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">model_file</span> <span class="ow">in</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">mlmodel_dir</span> <span class="o">+</span> <span class="s2">&quot;/**/*&quot;</span><span class="p">,</span> <span class="n">recursive</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
            <span class="n">zip_buffer</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">model_file</span><span class="p">,</span> <span class="n">arcname</span><span class="o">=</span><span class="n">path</span><span class="o">.</span><span class="n">relpath</span><span class="p">(</span><span class="n">model_file</span><span class="p">,</span> <span class="n">mlmodel_dir</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">buffer</span><span class="p">,</span> <span class="n">file_ext</span></div>


<div class="viewcode-block" id="_log_model"><a class="viewcode-back" href="../../../splicemachine.mlflow_support.html#splicemachine.mlflow_support.mlflow_support._log_model">[docs]</a><span class="nd">@_mlflow_patch</span><span class="p">(</span><span class="s1">&#39;log_model&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">_log_model</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;model&#39;</span><span class="p">,</span> <span class="n">model_lib</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">flavor_options</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Log a trained machine learning model</span>

<span class="sd">    :param model: (Model) is the trained Spark/SKlearn/H2O/Keras model</span>
<span class="sd">        with the current run</span>
<span class="sd">    :param name: (str) the run relative name to store the model under. [Deault &#39;model&#39;]</span>
<span class="sd">    :param model_lib: An optional param specifying the model type of the model to log</span>
<span class="sd">        Available options match the mlflow built-in model flavors https://www.mlflow.org/docs/1.8.0/models.html#built-in-model-flavors</span>
<span class="sd">    :param flavor_options: (**kwargs) The full set of save options to pass into the save_model function. If this is passed,</span>
<span class="sd">        model_class must also be provided and the keys of this dictionary must match the params of that functions signature</span>
<span class="sd">        (ie mlflow.pyfunc.save_model). An example of pyfuncs signature is here, although each flavor has its own.</span>
<span class="sd">        https://mlflow.org/docs/latest/python_api/mlflow.pyfunc.html#mlflow.pyfunc.save_model</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">_check_for_splice_ctx</span><span class="p">()</span>

    <span class="c1"># Make sure no models have been logged to this run</span>
    <span class="k">if</span> <span class="n">_get_current_run_data</span><span class="p">()</span><span class="o">.</span><span class="n">tags</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;splice.model_name&#39;</span><span class="p">):</span>  <span class="c1"># this function has already run</span>
        <span class="k">raise</span> <span class="n">SpliceMachineException</span><span class="p">(</span><span class="s2">&quot;Only one model is permitted per run.&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">flavor_options</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">model_lib</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">SpliceMachineException</span><span class="p">(</span><span class="s2">&quot;You cannot set mlflow-flavor specific options without setting the model library. &quot;</span>
                                     <span class="s2">&quot;Either set model_lib, or use the native mlflow.&lt;flavor&gt;.log_model function&quot;</span><span class="p">)</span>

    <span class="n">model_class</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="vm">__class__</span><span class="p">)</span>

    <span class="n">run_id</span> <span class="o">=</span> <span class="n">mlflow</span><span class="o">.</span><span class="n">active_run</span><span class="p">()</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">run_uuid</span>
    <span class="n">buffer</span><span class="p">,</span> <span class="n">file_ext</span> <span class="o">=</span> <span class="n">__get_serialized_mlmodel</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">model_lib</span><span class="o">=</span><span class="n">model_lib</span><span class="p">,</span> <span class="o">**</span><span class="n">flavor_options</span><span class="p">)</span>
    <span class="n">buffer</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">insert_artifact</span><span class="p">(</span><span class="n">splice_context</span><span class="o">=</span><span class="n">mlflow</span><span class="o">.</span><span class="n">_splice_context</span><span class="p">,</span> <span class="n">byte_array</span><span class="o">=</span><span class="nb">bytearray</span><span class="p">(</span><span class="n">buffer</span><span class="o">.</span><span class="n">read</span><span class="p">()),</span> <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>
                    <span class="n">run_uuid</span><span class="o">=</span><span class="n">run_id</span><span class="p">,</span> <span class="n">file_ext</span><span class="o">=</span><span class="n">file_ext</span><span class="p">)</span>

    <span class="c1"># Set the model metadata as tags after successful logging</span>
    <span class="n">mlflow</span><span class="o">.</span><span class="n">set_tag</span><span class="p">(</span><span class="s1">&#39;splice.model_name&#39;</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>  <span class="c1"># read in backend for deployment</span>
    <span class="n">mlflow</span><span class="o">.</span><span class="n">set_tag</span><span class="p">(</span><span class="s1">&#39;splice.model_type&#39;</span><span class="p">,</span> <span class="n">model_class</span><span class="p">)</span>
    <span class="n">mlflow</span><span class="o">.</span><span class="n">set_tag</span><span class="p">(</span><span class="s1">&#39;splice.model_py_version&#39;</span><span class="p">,</span> <span class="n">_PYTHON_VERSION</span><span class="p">)</span></div>


<div class="viewcode-block" id="_end_run"><a class="viewcode-back" href="../../../splicemachine.mlflow_support.html#splicemachine.mlflow_support.mlflow_support._end_run">[docs]</a><span class="nd">@_mlflow_patch</span><span class="p">(</span><span class="s1">&#39;end_run&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">_end_run</span><span class="p">(</span><span class="n">status</span><span class="o">=</span><span class="n">RunStatus</span><span class="o">.</span><span class="n">to_string</span><span class="p">(</span><span class="n">RunStatus</span><span class="o">.</span><span class="n">FINISHED</span><span class="p">),</span> <span class="n">save_html</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;End an active MLflow run (if there is one).</span>

<span class="sd">    .. code-block:: python</span>
<span class="sd">        :caption: Example</span>

<span class="sd">        import mlflow</span>

<span class="sd">        # Start run and get status</span>
<span class="sd">        mlflow.start_run()</span>
<span class="sd">        run = mlflow.active_run()</span>
<span class="sd">        print(&quot;run_id: {}; status: {}&quot;.format(run.info.run_id, run.info.status))</span>

<span class="sd">        # End run and get status</span>
<span class="sd">        mlflow.end_run()</span>
<span class="sd">        run = mlflow.get_run(run.info.run_id)</span>
<span class="sd">        print(&quot;run_id: {}; status: {}&quot;.format(run.info.run_id, run.info.status))</span>
<span class="sd">        print(&quot;--&quot;)</span>

<span class="sd">        # Check for any active runs</span>
<span class="sd">        print(&quot;Active run: {}&quot;.format(mlflow.active_run()))</span>

<span class="sd">    .. code-block:: text</span>
<span class="sd">        :caption: Output</span>

<span class="sd">        run_id: b47ee4563368419880b44ad8535f6371; status: RUNNING</span>
<span class="sd">        run_id: b47ee4563368419880b44ad8535f6371; status: FINISHED</span>
<span class="sd">        --</span>
<span class="sd">        Active run: None</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">mlflow</span><span class="o">.</span><span class="n">_notebook_history</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">mlflow</span><span class="p">,</span> <span class="s1">&#39;_splice_context&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">mlflow</span><span class="o">.</span><span class="n">active_run</span><span class="p">():</span>
        <span class="k">with</span> <span class="n">NamedTemporaryFile</span><span class="p">()</span> <span class="k">as</span> <span class="n">temp_file</span><span class="p">:</span>
            <span class="n">nb</span> <span class="o">=</span> <span class="n">nbf</span><span class="o">.</span><span class="n">v4</span><span class="o">.</span><span class="n">new_notebook</span><span class="p">()</span>
            <span class="n">nb</span><span class="p">[</span><span class="s1">&#39;cells&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">nbf</span><span class="o">.</span><span class="n">v4</span><span class="o">.</span><span class="n">new_code_cell</span><span class="p">(</span><span class="n">code</span><span class="p">)</span> <span class="k">for</span> <span class="n">code</span> <span class="ow">in</span> <span class="n">ipython</span><span class="o">.</span><span class="n">history_manager</span><span class="o">.</span><span class="n">input_hist_raw</span><span class="p">]</span>
            <span class="n">nbf</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">nb</span><span class="p">,</span> <span class="n">temp_file</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
            <span class="n">run_name</span> <span class="o">=</span> <span class="n">mlflow</span><span class="o">.</span><span class="n">get_run</span><span class="p">(</span><span class="n">mlflow</span><span class="o">.</span><span class="n">current_run_id</span><span class="p">())</span><span class="o">.</span><span class="n">to_dictionary</span><span class="p">()[</span><span class="s1">&#39;data&#39;</span><span class="p">][</span><span class="s1">&#39;tags&#39;</span><span class="p">][</span><span class="s1">&#39;mlflow.runName&#39;</span><span class="p">]</span>
            <span class="n">mlflow</span><span class="o">.</span><span class="n">log_artifact</span><span class="p">(</span><span class="n">temp_file</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">run_name</span><span class="si">}</span><span class="s1">_run_log.ipynb&#39;</span><span class="p">)</span>
            <span class="n">typ</span><span class="p">,</span><span class="n">ext</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;html&#39;</span><span class="p">,</span><span class="s1">&#39;html&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="n">save_html</span> <span class="k">else</span> <span class="p">(</span><span class="s1">&#39;script&#39;</span><span class="p">,</span><span class="s1">&#39;py&#39;</span><span class="p">)</span>
            <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;jupyter nbconvert --to </span><span class="si">{</span><span class="n">typ</span><span class="si">}</span><span class="s1"> </span><span class="si">{</span><span class="n">temp_file</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">mlflow</span><span class="o">.</span><span class="n">log_artifact</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">temp_file</span><span class="o">.</span><span class="n">name</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s1">.</span><span class="si">{</span><span class="n">ext</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">run_name</span><span class="si">}</span><span class="s1">_run_log.</span><span class="si">{</span><span class="n">ext</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">orig</span> <span class="o">=</span> <span class="n">gorilla</span><span class="o">.</span><span class="n">get_original_attribute</span><span class="p">(</span><span class="n">mlflow</span><span class="p">,</span> <span class="s2">&quot;end_run&quot;</span><span class="p">)</span>
    <span class="n">orig</span><span class="p">(</span><span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="p">)</span></div>

<div class="viewcode-block" id="_start_run"><a class="viewcode-back" href="../../../splicemachine.mlflow_support.html#splicemachine.mlflow_support.mlflow_support._start_run">[docs]</a><span class="nd">@_mlflow_patch</span><span class="p">(</span><span class="s1">&#39;start_run&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">_start_run</span><span class="p">(</span><span class="n">run_id</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">tags</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">experiment_id</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">run_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">nested</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Start a new run</span>

<span class="sd">    :Example:</span>
<span class="sd">        .. code-block:: python</span>
<span class="sd">    </span>
<span class="sd">            mlflow.start_run(run_name=&#39;my_run&#39;)\n</span>
<span class="sd">            # or\n</span>
<span class="sd">            with mlflow.start_run(run_name=&#39;my_run&#39;):</span>
<span class="sd">                ...</span>


<span class="sd">    :param tags: a dictionary containing metadata about the current run. \</span>
<span class="sd">        For example: \</span>
<span class="sd">            { \</span>
<span class="sd">                &#39;team&#39;: &#39;pd&#39;, \</span>
<span class="sd">                &#39;purpose&#39;: &#39;r&amp;d&#39; \</span>
<span class="sd">            }</span>
<span class="sd">    :param run_name: (str) an optional name for the run to show up in the MLFlow UI. [Default None]</span>
<span class="sd">    :param run_id: (str) if you want to reincarnate an existing run, pass in the run id [Default None]</span>
<span class="sd">    :param experiment_id: (int) if you would like to create an experiment/use one for this run [Default None]</span>
<span class="sd">    :param nested: (bool) Controls whether run is nested in parent run. True creates a nest run [Default False]</span>
<span class="sd">    :return: (ActiveRun) the mlflow active run object</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">tags</span> <span class="o">=</span> <span class="n">tags</span> <span class="ow">or</span> <span class="p">{}</span>
    <span class="n">tags</span><span class="p">[</span><span class="s1">&#39;mlflow.user&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">__get_active_user</span><span class="p">()</span>

    <span class="n">orig</span> <span class="o">=</span> <span class="n">gorilla</span><span class="o">.</span><span class="n">get_original_attribute</span><span class="p">(</span><span class="n">mlflow</span><span class="p">,</span> <span class="s2">&quot;start_run&quot;</span><span class="p">)</span>
    <span class="n">active_run</span> <span class="o">=</span> <span class="n">orig</span><span class="p">(</span><span class="n">run_id</span><span class="o">=</span><span class="n">run_id</span><span class="p">,</span> <span class="n">experiment_id</span><span class="o">=</span><span class="n">experiment_id</span><span class="p">,</span> <span class="n">run_name</span><span class="o">=</span><span class="n">run_name</span><span class="p">,</span> <span class="n">nested</span><span class="o">=</span><span class="n">nested</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">tags</span><span class="p">:</span>
        <span class="n">mlflow</span><span class="o">.</span><span class="n">set_tag</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">tags</span><span class="p">[</span><span class="n">key</span><span class="p">])</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">run_id</span><span class="p">:</span>
        <span class="n">mlflow</span><span class="o">.</span><span class="n">set_tag</span><span class="p">(</span><span class="s1">&#39;Run ID&#39;</span><span class="p">,</span> <span class="n">mlflow</span><span class="o">.</span><span class="n">active_run</span><span class="p">()</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">run_uuid</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">run_name</span><span class="p">:</span>
        <span class="n">mlflow</span><span class="o">.</span><span class="n">set_tag</span><span class="p">(</span><span class="s1">&#39;mlflow.runName&#39;</span><span class="p">,</span> <span class="n">run_name</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">mlflow</span><span class="p">,</span><span class="s1">&#39;_active_training_set&#39;</span><span class="p">):</span>
        <span class="n">mlflow</span><span class="o">.</span><span class="n">_active_training_set</span><span class="o">.</span><span class="n">_register_metadata</span><span class="p">(</span><span class="n">mlflow</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">SpliceActiveRun</span><span class="p">(</span><span class="n">active_run</span><span class="p">)</span></div>

<div class="viewcode-block" id="_remove_active_training_set"><a class="viewcode-back" href="../../../splicemachine.mlflow_support.html#splicemachine.mlflow_support.mlflow_support._remove_active_training_set">[docs]</a><span class="nd">@_mlflow_patch</span><span class="p">(</span><span class="s1">&#39;remove_active_training_set&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">_remove_active_training_set</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Removes the active training set from mlflow. This function deletes mlflows active training set (retrieved from</span>
<span class="sd">    the feature store), which will in turn stop the automated logging of features to the active mlflow run. To recreate</span>
<span class="sd">    an active training set, call fs.get_training_set or fs.get_training_set_from_view in the Feature Store.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">mlflow</span><span class="p">,</span><span class="s1">&#39;_active_training_set&#39;</span><span class="p">):</span>
        <span class="k">del</span> <span class="n">mlflow</span><span class="o">.</span><span class="n">_active_training_set</span></div>


<div class="viewcode-block" id="_log_pipeline_stages"><a class="viewcode-back" href="../../../splicemachine.mlflow_support.html#splicemachine.mlflow_support.mlflow_support._log_pipeline_stages">[docs]</a><span class="nd">@_mlflow_patch</span><span class="p">(</span><span class="s1">&#39;log_pipeline_stages&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">_log_pipeline_stages</span><span class="p">(</span><span class="n">pipeline</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Log the pipeline stages of a Spark Pipeline as params for the run</span>

<span class="sd">    :param pipeline: (PipelineModel) fitted/unitted pipeline</span>
<span class="sd">    :return: None</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">stage_number</span><span class="p">,</span> <span class="n">pipeline_stage</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">SparkUtils</span><span class="o">.</span><span class="n">get_stages</span><span class="p">(</span><span class="n">pipeline</span><span class="p">)):</span>
        <span class="n">readable_stage_name</span> <span class="o">=</span> <span class="n">SparkUtils</span><span class="o">.</span><span class="n">readable_pipeline_stage</span><span class="p">(</span><span class="n">pipeline_stage</span><span class="p">)</span>
        <span class="n">mlflow</span><span class="o">.</span><span class="n">log_param</span><span class="p">(</span><span class="s1">&#39;Stage&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">stage_number</span><span class="p">),</span> <span class="n">readable_stage_name</span><span class="p">)</span></div>


<div class="viewcode-block" id="_log_feature_transformations"><a class="viewcode-back" href="../../../splicemachine.mlflow_support.html#splicemachine.mlflow_support.mlflow_support._log_feature_transformations">[docs]</a><span class="nd">@_mlflow_patch</span><span class="p">(</span><span class="s1">&#39;log_feature_transformations&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">_log_feature_transformations</span><span class="p">(</span><span class="n">unfit_pipeline</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Log feature transformations for an unfit spark pipeline</span>
<span class="sd">    Logs --&gt; feature movement through the pipeline</span>

<span class="sd">    :param unfit_pipeline: (PipelineModel) unfit spark pipeline to log</span>
<span class="sd">    :return: None</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">transformations</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="p">[[],</span> <span class="kc">None</span><span class="p">])</span>  <span class="c1"># transformations, outputColumn</span>

    <span class="k">for</span> <span class="n">stage</span> <span class="ow">in</span> <span class="n">SparkUtils</span><span class="o">.</span><span class="n">get_stages</span><span class="p">(</span><span class="n">unfit_pipeline</span><span class="p">):</span>
        <span class="n">input_cols</span><span class="p">,</span> <span class="n">output_col</span> <span class="o">=</span> <span class="n">SparkUtils</span><span class="o">.</span><span class="n">get_cols</span><span class="p">(</span><span class="n">stage</span><span class="p">,</span> <span class="n">get_input</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span> <span class="n">SparkUtils</span><span class="o">.</span><span class="n">get_cols</span><span class="p">(</span><span class="n">stage</span><span class="p">,</span> <span class="n">get_input</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">input_cols</span> <span class="ow">and</span> <span class="n">output_col</span><span class="p">:</span>  <span class="c1"># make sure it could parse transformer</span>
            <span class="k">for</span> <span class="n">column</span> <span class="ow">in</span> <span class="n">input_cols</span><span class="p">:</span>
                <span class="n">first_column_found</span> <span class="o">=</span> <span class="n">SparkUtils</span><span class="o">.</span><span class="n">find_spark_transformer_inputs_by_output</span><span class="p">(</span><span class="n">transformations</span><span class="p">,</span> <span class="n">column</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">first_column_found</span><span class="p">:</span>  <span class="c1"># column is not original</span>
                    <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">first_column_found</span><span class="p">:</span>
                        <span class="n">transformations</span><span class="p">[</span><span class="n">f</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">output_col</span>
                        <span class="n">transformations</span><span class="p">[</span><span class="n">f</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                            <span class="n">SparkUtils</span><span class="o">.</span><span class="n">readable_pipeline_stage</span><span class="p">(</span><span class="n">stage</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">transformations</span><span class="p">[</span><span class="n">column</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">output_col</span>
                    <span class="n">transformations</span><span class="p">[</span><span class="n">column</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">SparkUtils</span><span class="o">.</span><span class="n">readable_pipeline_stage</span><span class="p">(</span><span class="n">stage</span><span class="p">))</span>

    <span class="k">for</span> <span class="n">column</span> <span class="ow">in</span> <span class="n">transformations</span><span class="p">:</span>
        <span class="n">param_value</span> <span class="o">=</span> <span class="s1">&#39; -&gt; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">column</span><span class="p">]</span> <span class="o">+</span> <span class="n">transformations</span><span class="p">[</span><span class="n">column</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span>
                                  <span class="p">[</span><span class="n">transformations</span><span class="p">[</span><span class="n">column</span><span class="p">][</span><span class="mi">1</span><span class="p">]])</span>
        <span class="n">mlflow</span><span class="o">.</span><span class="n">log_param</span><span class="p">(</span><span class="s1">&#39;Column- &#39;</span> <span class="o">+</span> <span class="n">column</span><span class="p">,</span> <span class="n">param_value</span><span class="p">)</span></div>


<div class="viewcode-block" id="_log_model_params"><a class="viewcode-back" href="../../../splicemachine.mlflow_support.html#splicemachine.mlflow_support.mlflow_support._log_model_params">[docs]</a><span class="nd">@_mlflow_patch</span><span class="p">(</span><span class="s1">&#39;log_model_params&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">_log_model_params</span><span class="p">(</span><span class="n">pipeline_or_model</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Log the parameters of a fitted spark model or a model stage of a fitted spark pipeline</span>

<span class="sd">    :param pipeline_or_model: fitted spark pipeline/fitted spark model</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">SparkUtils</span><span class="o">.</span><span class="n">get_model_stage</span><span class="p">(</span><span class="n">pipeline_or_model</span><span class="p">)</span>

    <span class="n">mlflow</span><span class="o">.</span><span class="n">log_param</span><span class="p">(</span><span class="s1">&#39;model&#39;</span><span class="p">,</span> <span class="n">SparkUtils</span><span class="o">.</span><span class="n">readable_pipeline_stage</span><span class="p">(</span><span class="n">model</span><span class="p">))</span>
    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="s1">&#39;_java_obj&#39;</span><span class="p">):</span>
        <span class="n">verbose_parameters</span> <span class="o">=</span> <span class="n">SparkUtils</span><span class="o">.</span><span class="n">parse_string_parameters</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">_java_obj</span><span class="o">.</span><span class="n">extractParamMap</span><span class="p">())</span>
    <span class="k">elif</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="s1">&#39;getClassifier&#39;</span><span class="p">):</span>
        <span class="n">verbose_parameters</span> <span class="o">=</span> <span class="n">SparkUtils</span><span class="o">.</span><span class="n">parse_string_parameters</span><span class="p">(</span>
            <span class="n">model</span><span class="o">.</span><span class="n">getClassifier</span><span class="p">()</span><span class="o">.</span><span class="n">_java_obj</span><span class="o">.</span><span class="n">extractParamMap</span><span class="p">())</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Could not parse model type: &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">model</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">verbose_parameters</span><span class="p">:</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">verbose_parameters</span><span class="p">[</span><span class="n">param</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">value</span><span class="p">:</span> <span class="c1"># Spark 3.0 leafCol returns an empty parameter, mlflow fails if you try to log an empty string</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">value</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
                <span class="n">mlflow</span><span class="o">.</span><span class="n">log_param</span><span class="p">(</span><span class="n">param</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span> <span class="n">value</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">mlflow</span><span class="o">.</span><span class="n">log_param</span><span class="p">(</span><span class="n">param</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span> <span class="n">value</span><span class="p">)</span></div>


<div class="viewcode-block" id="_timer"><a class="viewcode-back" href="../../../splicemachine.mlflow_support.html#splicemachine.mlflow_support.mlflow_support._timer">[docs]</a><span class="nd">@_mlflow_patch</span><span class="p">(</span><span class="s1">&#39;timer&#39;</span><span class="p">)</span>
<span class="nd">@contextmanager</span>
<span class="k">def</span> <span class="nf">_timer</span><span class="p">(</span><span class="n">timer_name</span><span class="p">,</span> <span class="n">param</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Context manager for logging</span>

<span class="sd">    :Example:</span>
<span class="sd">        .. code-block:: python</span>
<span class="sd">    </span>
<span class="sd">            with mlflow.timer(&#39;my_timer&#39;): \n</span>
<span class="sd">                ...</span>

<span class="sd">    :param timer_name: (str) the name of the timer</span>
<span class="sd">    :param param: (bool) whether or not to log the timer as a param (default=True). If false, logs as metric.</span>
<span class="sd">    :return: None</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">t0</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Starting Code Block </span><span class="si">{</span><span class="n">timer_name</span><span class="si">}</span><span class="s1">...&#39;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39; &#39;</span><span class="p">)</span>
        <span class="k">yield</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="n">t1</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">t0</span>
        <span class="c1"># Syntactic Sugar</span>
        <span class="p">(</span><span class="n">mlflow</span><span class="o">.</span><span class="n">log_param</span> <span class="k">if</span> <span class="n">param</span> <span class="k">else</span> <span class="n">mlflow</span><span class="o">.</span><span class="n">log_metric</span><span class="p">)(</span><span class="n">timer_name</span><span class="p">,</span> <span class="n">t1</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Done.&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Code Block </span><span class="si">{</span><span class="n">timer_name</span><span class="si">}</span><span class="s2">:</span><span class="se">\n</span><span class="s2">Ran in </span><span class="si">{</span><span class="nb">round</span><span class="p">(</span><span class="n">t1</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span><span class="si">}</span><span class="s2"> secs</span><span class="se">\n</span><span class="s2">Ran in </span><span class="si">{</span><span class="nb">round</span><span class="p">(</span><span class="n">t1</span> <span class="o">/</span> <span class="mi">60</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span><span class="si">}</span><span class="s2"> mins&quot;</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="_download_artifact"><a class="viewcode-back" href="../../../splicemachine.mlflow_support.html#splicemachine.mlflow_support.mlflow_support._download_artifact">[docs]</a><span class="nd">@_mlflow_patch</span><span class="p">(</span><span class="s1">&#39;download_artifact&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">_download_artifact</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">local_path</span><span class="p">,</span> <span class="n">run_id</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Download the artifact at the given run id (active default) + name to the local path</span>

<span class="sd">    :param name: (str) artifact name to load (with respect to the run)</span>
<span class="sd">    :param local_path: (str) local path to download the model to. This path MUST include the file extension</span>
<span class="sd">    :param run_id: (str) the run id to download the artifact from. Defaults to active run</span>
<span class="sd">    :return: None</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">_check_for_splice_ctx</span><span class="p">()</span>
    <span class="n">file_ext</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">local_path</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>

    <span class="n">run_id</span> <span class="o">=</span> <span class="n">run_id</span> <span class="ow">or</span> <span class="n">mlflow</span><span class="o">.</span><span class="n">active_run</span><span class="p">()</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">run_uuid</span>
    <span class="n">blob_data</span><span class="p">,</span> <span class="n">f_ext</span> <span class="o">=</span> <span class="n">SparkUtils</span><span class="o">.</span><span class="n">retrieve_artifact_stream</span><span class="p">(</span><span class="n">mlflow</span><span class="o">.</span><span class="n">_splice_context</span><span class="p">,</span> <span class="n">run_id</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">f_ext</span> <span class="ow">in</span> <span class="n">FileExtensions</span><span class="o">.</span><span class="n">get_valid</span><span class="p">():</span>
        <span class="n">f_ext</span> <span class="o">=</span> <span class="s1">&#39;zip&#39;</span>  <span class="c1"># we zip up these models, even though we use the file ext to identify model type</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">file_ext</span><span class="p">:</span>  <span class="c1"># If the user didn&#39;t provide the file (ie entered . as the local_path), fill it in for them</span>
        <span class="n">local_path</span> <span class="o">+=</span> <span class="sa">f</span><span class="s1">&#39;/</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s1">.</span><span class="si">{</span><span class="n">f_ext</span><span class="si">}</span><span class="s1">&#39;</span>

    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">local_path</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">artifact_file</span><span class="p">:</span>
        <span class="n">artifact_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">blob_data</span><span class="p">)</span></div>


<div class="viewcode-block" id="_get_model_name"><a class="viewcode-back" href="../../../splicemachine.mlflow_support.html#splicemachine.mlflow_support.mlflow_support._get_model_name">[docs]</a><span class="nd">@_mlflow_patch</span><span class="p">(</span><span class="s1">&#39;get_model_name&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">_get_model_name</span><span class="p">(</span><span class="n">run_id</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Gets the model name associated with a run or None</span>

<span class="sd">    :param run_id: (str) the run_id that the model is stored under</span>
<span class="sd">    :return: (str or None) The model name if it exists</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">_CLIENT</span><span class="o">.</span><span class="n">get_run</span><span class="p">(</span><span class="n">run_id</span><span class="p">)</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">tags</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;splice.model_name&#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="_load_model"><a class="viewcode-back" href="../../../splicemachine.mlflow_support.html#splicemachine.mlflow_support.mlflow_support._load_model">[docs]</a><span class="k">def</span> <span class="nf">_load_model</span><span class="p">(</span><span class="n">run_id</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">as_pyfunc</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Download and deserialize a serialized model</span>

<span class="sd">    :param run_id: (str) the id of the run to get a model from</span>
<span class="sd">        (the run must have an associated model with it named spark_model)</span>
<span class="sd">    :param name: (str) the name of the model in the database</span>
<span class="sd">    :param as_pyfunc: (bool) load as a model-agnostic pyfunc model</span>
<span class="sd">        (https://www.mlflow.org/docs/latest/models.html#python-function-python-function)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">run_id</span> <span class="ow">or</span> <span class="n">mlflow</span><span class="o">.</span><span class="n">active_run</span><span class="p">()):</span>
        <span class="k">raise</span> <span class="n">SpliceMachineException</span><span class="p">(</span><span class="s2">&quot;You need to pass in a run_id or start an mlflow run.&quot;</span><span class="p">)</span>

    <span class="n">run_id</span> <span class="o">=</span> <span class="n">run_id</span> <span class="ow">or</span> <span class="n">mlflow</span><span class="o">.</span><span class="n">active_run</span><span class="p">()</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">run_uuid</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">name</span> <span class="ow">or</span> <span class="n">_get_model_name</span><span class="p">(</span><span class="n">run_id</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">name</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">SpliceMachineException</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Uh Oh! Looks like there isn&#39;t a model logged with this run (</span><span class="si">{</span><span class="n">run_id</span><span class="si">}</span><span class="s2">)!&quot;</span>
                                     <span class="s2">&quot;If there is, pass in the name= parameter to this function&quot;</span><span class="p">)</span>
    <span class="n">model_blob</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">SparkUtils</span><span class="o">.</span><span class="n">retrieve_artifact_stream</span><span class="p">(</span><span class="n">mlflow</span><span class="o">.</span><span class="n">_splice_context</span><span class="p">,</span> <span class="n">run_id</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
    <span class="n">buffer</span> <span class="o">=</span> <span class="n">BytesIO</span><span class="p">()</span>
    <span class="n">buffer</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">buffer</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">model_blob</span><span class="p">)</span>

    <span class="k">with</span> <span class="n">TemporaryDirectory</span><span class="p">()</span> <span class="k">as</span> <span class="n">tempdir</span><span class="p">:</span>
        <span class="n">ZipFile</span><span class="p">(</span><span class="n">buffer</span><span class="p">)</span><span class="o">.</span><span class="n">extractall</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="n">tempdir</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">as_pyfunc</span><span class="p">:</span>
            <span class="n">mlflow_module</span> <span class="o">=</span> <span class="s1">&#39;pyfunc&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">tempdir</span><span class="si">}</span><span class="s1">/MLmodel&#39;</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">mlmodel_file</span><span class="p">:</span>
                <span class="n">loader_module</span> <span class="o">=</span> <span class="n">yaml</span><span class="o">.</span><span class="n">safe_load</span><span class="p">(</span><span class="n">mlmodel_file</span><span class="o">.</span><span class="n">read</span><span class="p">())[</span><span class="s1">&#39;flavors&#39;</span><span class="p">][</span><span class="s1">&#39;python_function&#39;</span><span class="p">][</span><span class="s1">&#39;loader_module&#39;</span><span class="p">]</span>
            <span class="n">mlflow_module</span> <span class="o">=</span> <span class="n">loader_module</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>  <span class="c1"># get the mlflow.(MODULE)</span>
            <span class="n">import_module</span><span class="p">(</span><span class="n">loader_module</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">mlflow</span><span class="p">,</span> <span class="n">mlflow_module</span><span class="p">)</span><span class="o">.</span><span class="n">load_model</span><span class="p">(</span><span class="n">tempdir</span><span class="p">)</span></div>


<div class="viewcode-block" id="_log_artifact"><a class="viewcode-back" href="../../../splicemachine.mlflow_support.html#splicemachine.mlflow_support.mlflow_support._log_artifact">[docs]</a><span class="nd">@_mlflow_patch</span><span class="p">(</span><span class="s1">&#39;log_artifact&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">_log_artifact</span><span class="p">(</span><span class="n">file_name</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">run_uuid</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Log an artifact for the active run</span>

<span class="sd">    :Example:</span>
<span class="sd">        .. code-block:: python</span>

<span class="sd">            with mlflow.start_run():\n</span>
<span class="sd">                mlflow.log_artifact(&#39;my_image.png&#39;)</span>

<span class="sd">    :param file_name: (str) the name of the file name to log</span>
<span class="sd">    :param name: (str) the name to store the artifact as. Defaults to the file name. If the name param includes the file</span>
<span class="sd">        extension (or is not passed in) you will be able to preview it in the mlflow UI (image, text, html, geojson files).</span>
<span class="sd">    :param run_uuid: (str) the run uuid of a previous run, if none, defaults to current run</span>
<span class="sd">    :return: None</span>
<span class="sd">    </span>
<span class="sd">    :NOTE: </span>
<span class="sd">        We do not currently support logging directories. If you would like to log a directory, please zip it first and log the zip file</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">_check_for_splice_ctx</span><span class="p">()</span>
    <span class="n">file_ext</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">file_name</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">lstrip</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)</span>

    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">file_name</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">artifact</span><span class="p">:</span>
        <span class="n">byte_stream</span> <span class="o">=</span> <span class="nb">bytearray</span><span class="p">(</span><span class="nb">bytes</span><span class="p">(</span><span class="n">artifact</span><span class="o">.</span><span class="n">read</span><span class="p">()))</span>

    <span class="n">run_id</span> <span class="o">=</span> <span class="n">run_uuid</span> <span class="ow">or</span> <span class="n">mlflow</span><span class="o">.</span><span class="n">active_run</span><span class="p">()</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">run_uuid</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">name</span> <span class="ow">or</span> <span class="n">file_name</span>
    <span class="n">insert_artifact</span><span class="p">(</span><span class="n">mlflow</span><span class="o">.</span><span class="n">_splice_context</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">byte_stream</span><span class="p">,</span> <span class="n">run_id</span><span class="p">,</span> <span class="n">file_ext</span><span class="o">=</span><span class="n">file_ext</span><span class="p">)</span></div>


<div class="viewcode-block" id="_login_director"><a class="viewcode-back" href="../../../splicemachine.mlflow_support.html#splicemachine.mlflow_support.mlflow_support._login_director">[docs]</a><span class="nd">@_mlflow_patch</span><span class="p">(</span><span class="s1">&#39;login_director&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">_login_director</span><span class="p">(</span><span class="n">username</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">jwt_token</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Authenticate into the MLManager Director</span>

<span class="sd">    :param username: (str) database username</span>
<span class="sd">    :param password: (str) database password</span>
<span class="sd">    :param jwt_token: (str) database JWT token authentication</span>

<span class="sd">    Either (username/password) for basic auth or jwt_token must be provided. Basic authentication takes precedence if set (mlflow default)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">username</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">password</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">password</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">username</span><span class="p">):</span>
        <span class="k">raise</span> <span class="n">SpliceMachineException</span><span class="p">(</span><span class="s2">&quot;You must either set both username and password, or neither. You cannot set just one&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">username</span> <span class="ow">and</span> <span class="n">password</span><span class="p">:</span>
        <span class="n">mlflow</span><span class="o">.</span><span class="n">_basic_auth</span> <span class="o">=</span> <span class="n">HTTPBasicAuth</span><span class="p">(</span><span class="n">username</span><span class="p">,</span> <span class="n">password</span><span class="p">)</span>
        <span class="n">mlflow</span><span class="o">.</span><span class="n">_username</span> <span class="o">=</span> <span class="n">username</span>
        <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;MLFLOW_TRACKING_USERNAME&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">username</span>
        <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;MLFLOW_TRACKING_PASSWORD&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">password</span>
    <span class="k">if</span> <span class="n">jwt_token</span><span class="p">:</span>
        <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;MLFLOW_TRACKING_TOKEN&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">jwt_token</span></div>


<div class="viewcode-block" id="__initiate_job"><a class="viewcode-back" href="../../../splicemachine.mlflow_support.html#splicemachine.mlflow_support.mlflow_support.__initiate_job">[docs]</a><span class="k">def</span> <span class="nf">__initiate_job</span><span class="p">(</span><span class="n">payload</span><span class="p">,</span> <span class="n">endpoint</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Send a job to the initiation endpoint</span>

<span class="sd">    :param payload: (dict) JSON payload for POST request</span>
<span class="sd">    :param endpoint: (str) REST endpoint to target</span>
<span class="sd">    :return: (str) Response text from request</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">mlflow</span><span class="p">,</span> <span class="s1">&#39;_basic_auth&#39;</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span>
            <span class="s2">&quot;You have not logged into MLManager director.&quot;</span>
            <span class="s2">&quot; Please run mlflow.login_director(username, password)&quot;</span>
        <span class="p">)</span>
    <span class="n">request</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">post</span><span class="p">(</span>
        <span class="n">get_pod_uri</span><span class="p">(</span><span class="s1">&#39;mlflow&#39;</span><span class="p">,</span> <span class="mi">5003</span><span class="p">,</span> <span class="n">_testing</span><span class="o">=</span><span class="n">_TESTING</span><span class="p">)</span> <span class="o">+</span> <span class="n">endpoint</span><span class="p">,</span>
        <span class="n">auth</span><span class="o">=</span><span class="n">mlflow</span><span class="o">.</span><span class="n">_basic_auth</span><span class="p">,</span>
        <span class="n">json</span><span class="o">=</span><span class="n">payload</span>
    <span class="p">)</span>

    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">ok</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Your Job has been submitted. The returned value of this function is&quot;</span>
              <span class="s2">&quot; the job id, which you can use to monitor the your task in real-time. Run mlflow.watch_job(&lt;job id&gt;) to&quot;</span>
              <span class="s2">&quot;stream them to stdout, or mlflow.fetch_logs(&lt;job id&gt;) to read them one time to a list&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">request</span><span class="o">.</span><span class="n">json</span><span class="p">()[</span><span class="s1">&#39;job_id&#39;</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Error! An error occurred while submitting your job&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">request</span><span class="o">.</span><span class="n">text</span></div>


<div class="viewcode-block" id="_deploy_aws"><a class="viewcode-back" href="../../../splicemachine.mlflow_support.html#splicemachine.mlflow_support.mlflow_support._deploy_aws">[docs]</a><span class="nd">@_mlflow_patch</span><span class="p">(</span><span class="s1">&#39;deploy_aws&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">_deploy_aws</span><span class="p">(</span><span class="n">app_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">region</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;us-east-2&#39;</span><span class="p">,</span> <span class="n">instance_type</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;ml.m5.xlarge&#39;</span><span class="p">,</span>
                <span class="n">run_id</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">instance_count</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">deployment_mode</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;replace&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Queue Job to deploy a run to sagemaker with the</span>
<span class="sd">    given run id (found in MLFlow UI or through search API)</span>

<span class="sd">    :param run_id: the id of the run to deploy. Will default to the current</span>
<span class="sd">        run id.</span>
<span class="sd">    :param app_name: the name of the app in sagemaker once deployed</span>
<span class="sd">    :param region: the sagemaker region to deploy to (us-east-2,</span>
<span class="sd">        us-west-1, us-west-2, eu-central-1 supported)</span>
<span class="sd">    :param instance_type: the EC2 Sagemaker instance type to deploy on</span>
<span class="sd">        (ml.m4.xlarge supported)</span>
<span class="sd">    :param instance_count: the number of instances to load balance predictions</span>
<span class="sd">        on</span>
<span class="sd">    :param deployment_mode: the method to deploy; create=application will fail</span>
<span class="sd">        if an app with the name specified already exists; replace=application</span>
<span class="sd">        in sagemaker will be replaced with this one if app already exists;</span>
<span class="sd">        add=add the specified model to a prexisting application (not recommended)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># get run from mlflow</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Processing...&quot;</span><span class="p">)</span>

    <span class="n">request_payload</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;handler_name&#39;</span><span class="p">:</span> <span class="s1">&#39;DEPLOY_AWS&#39;</span><span class="p">,</span> <span class="s1">&#39;run_id&#39;</span><span class="p">:</span> <span class="n">run_id</span><span class="p">,</span>
        <span class="s1">&#39;region&#39;</span><span class="p">:</span> <span class="n">region</span><span class="p">,</span> <span class="s1">&#39;user&#39;</span><span class="p">:</span> <span class="n">__get_active_user</span><span class="p">(),</span>
        <span class="s1">&#39;instance_type&#39;</span><span class="p">:</span> <span class="n">instance_type</span><span class="p">,</span> <span class="s1">&#39;instance_count&#39;</span><span class="p">:</span> <span class="n">instance_count</span><span class="p">,</span>
        <span class="s1">&#39;deployment_mode&#39;</span><span class="p">:</span> <span class="n">deployment_mode</span><span class="p">,</span> <span class="s1">&#39;app_name&#39;</span><span class="p">:</span> <span class="n">app_name</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="n">__initiate_job</span><span class="p">(</span><span class="n">request_payload</span><span class="p">,</span> <span class="s1">&#39;/api/rest/initiate&#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="_deploy_azure"><a class="viewcode-back" href="../../../splicemachine.mlflow_support.html#splicemachine.mlflow_support.mlflow_support._deploy_azure">[docs]</a><span class="nd">@_mlflow_patch</span><span class="p">(</span><span class="s1">&#39;deploy_azure&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">_deploy_azure</span><span class="p">(</span><span class="n">endpoint_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">resource_group</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">workspace</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">run_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">region</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;East US&#39;</span><span class="p">,</span>
                  <span class="n">cpu_cores</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.1</span><span class="p">,</span> <span class="n">allocated_ram</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">,</span> <span class="n">model_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Deploy a given run to AzureML.</span>

<span class="sd">    :param endpoint_name: (str) the name of the endpoint in AzureML when deployed to</span>
<span class="sd">        Azure Container Services. Must be unique.</span>
<span class="sd">    :param resource_group: (str) Azure Resource Group for model. Automatically created if</span>
<span class="sd">        it doesn&#39;t exist.</span>
<span class="sd">    :param workspace: (str) the AzureML workspace to deploy the model under.</span>
<span class="sd">        Will be created if it doesn&#39;t exist</span>
<span class="sd">    :param run_id: (str) if specified, will deploy a previous run (</span>
<span class="sd">        must have an spark model logged). Otherwise, will default to the active run</span>
<span class="sd">    :param region: (str) AzureML Region to deploy to: Can be East US, East US 2, Central US,</span>
<span class="sd">        West US 2, North Europe, West Europe or Japan East</span>
<span class="sd">    :param cpu_cores: (float) Number of CPU Cores to allocate to the instance.</span>
<span class="sd">        Can be fractional. Default=0.1</span>
<span class="sd">    :param allocated_ram: (float) amount of RAM, in GB, allocated to the container.</span>
<span class="sd">        Default=0.5</span>
<span class="sd">    :param model_name: (str) If specified, this will be the name of the model in AzureML.</span>
<span class="sd">        Otherwise, the model name will be randomly generated.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">request_payload</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;handler_name&#39;</span><span class="p">:</span> <span class="s1">&#39;DEPLOY_AZURE&#39;</span><span class="p">,</span>
        <span class="s1">&#39;endpoint_name&#39;</span><span class="p">:</span> <span class="n">endpoint_name</span><span class="p">,</span>
        <span class="s1">&#39;resource_group&#39;</span><span class="p">:</span> <span class="n">resource_group</span><span class="p">,</span>
        <span class="s1">&#39;workspace&#39;</span><span class="p">:</span> <span class="n">workspace</span><span class="p">,</span>
        <span class="s1">&#39;region&#39;</span><span class="p">:</span> <span class="n">region</span><span class="p">,</span>
        <span class="s1">&#39;run_id&#39;</span><span class="p">:</span> <span class="n">run_id</span><span class="p">,</span>
        <span class="s1">&#39;cpu_cores&#39;</span><span class="p">:</span> <span class="n">cpu_cores</span><span class="p">,</span>
        <span class="s1">&#39;allocated_ram&#39;</span><span class="p">:</span> <span class="n">allocated_ram</span><span class="p">,</span>
        <span class="s1">&#39;model_name&#39;</span><span class="p">:</span> <span class="n">model_name</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">__initiate_job</span><span class="p">(</span><span class="n">request_payload</span><span class="p">,</span> <span class="s1">&#39;/api/rest/initiate&#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="_deploy_kubernetes"><a class="viewcode-back" href="../../../splicemachine.mlflow_support.html#splicemachine.mlflow_support.mlflow_support._deploy_kubernetes">[docs]</a><span class="nd">@_mlflow_patch</span><span class="p">(</span><span class="s1">&#39;deploy_kubernetes&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">_deploy_kubernetes</span><span class="p">(</span><span class="n">run_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">service_port</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">80</span><span class="p">,</span>
                       <span class="n">base_replicas</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">autoscaling_enabled</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                       <span class="n">max_replicas</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span> <span class="n">target_cpu_utilization</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">50</span><span class="p">,</span>
                       <span class="n">disable_nginx</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">gunicorn_workers</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
                       <span class="n">resource_requests_enabled</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">resource_limits_enabled</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                       <span class="n">cpu_request</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">,</span> <span class="n">cpu_limit</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">memory_request</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;512Mi&quot;</span><span class="p">,</span>
                       <span class="n">memory_limit</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;2048Mi&quot;</span><span class="p">,</span> <span class="n">expose_external</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Deploy model associated with the specified or active run to Kubernetes cluster.\n</span>

<span class="sd">    Creates the Following Resources:</span>
<span class="sd">        * Pod (with your model loaded in via an init container)</span>
<span class="sd">        * ReplicaSet (configured to base replicas specified)</span>
<span class="sd">        * HPA (if autoscaling is enabled)</span>
<span class="sd">        * Service (model-&lt;run id&gt;.&lt;db namespace&gt;.svc.cluster.local:&lt;service port specified&gt;)</span>
<span class="sd">        * Deployment</span>
<span class="sd">        * Ingress (if expose enable is set to True) (on &lt;your cluster url&gt;/&lt;run id&gt;/invocations)</span>

<span class="sd">    :param run_id: specified if overriding the active run</span>
<span class="sd">    :param service_port: (default 80) the port that the prediction service runs on internally in the cluster</span>
<span class="sd">    :param autoscaling_enabled: (default False) whether or not to provision a Horizontal Pod Autoscaler to provision</span>
<span class="sd">            pods dynamically</span>
<span class="sd">    :param max_replicas: (default 2) [USED IF AUTOSCALING ENABLED] max number of pods to scale up to</span>
<span class="sd">    :param target_cpu_utilization: (default 50) [USED IF AUTOSCALING ENABLED] the cpu utilization to scale up to</span>
<span class="sd">            new pods on</span>
<span class="sd">    :param disable_nginx: (default False) disable nginx inside of the pod (recommended)</span>
<span class="sd">    :param gunicorn_workers: (default 1) [MUST BE 1 FOR SPARK ML models TO PREVENT OOM] Number of web workers.</span>
<span class="sd">    :param resource_requests_enabled: (default False) whether or not to enable Kubernetes resource requests</span>
<span class="sd">    :param resource_limits_enabled: (default False) whether or not to enable Kubernetes resource limits</span>
<span class="sd">    :param cpu_request: (default 0.5) [USED IF RESOURCE REQUESTS ENABLED] number of CPU to request</span>
<span class="sd">    :param cpu_limit: (default 1) [USED IF RESOURCE LIMITS ENABLED] number of CPU to cap at</span>
<span class="sd">    :param memory_request: (default 512Mi) [USED IF RESOURCE REQUESTS ENABLED] amount of RAM to request</span>
<span class="sd">    :param memory_limit: (default 2048Mi) [USED IF RESOURCE LIMITS ENABLED] amount of RAM to limit at</span>
<span class="sd">    :param expose_external: (default False) whether or not to create Ingress resource to deploy outside of the cluster.</span>
<span class="sd">        :NOTE:</span>
<span class="sd">            .. code-block:: text</span>

<span class="sd">                It is not recommended to create an Ingress resource using this parameter, as your model will be</span>
<span class="sd">                deployed with no authorization (and public access). Instead, it is better to deploy your model</span>
<span class="sd">                as an internal service, and deploy an authentication proxy (such as https://github.com/oauth2-proxy/oauth2-proxy)</span>
<span class="sd">                to proxy traffic to your internal service after authenticating.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Processing...&quot;</span><span class="p">)</span>

    <span class="n">payload</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;run_id&#39;</span><span class="p">:</span> <span class="n">run_id</span> <span class="ow">or</span> <span class="n">mlflow</span><span class="o">.</span><span class="n">active_run</span><span class="p">()</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">run_uuid</span><span class="p">,</span> <span class="s1">&#39;handler_name&#39;</span><span class="p">:</span> <span class="s1">&#39;DEPLOY_KUBERNETES&#39;</span><span class="p">,</span>
        <span class="s1">&#39;service_port&#39;</span><span class="p">:</span> <span class="n">service_port</span><span class="p">,</span> <span class="s1">&#39;base_replicas&#39;</span><span class="p">:</span> <span class="n">base_replicas</span><span class="p">,</span> <span class="s1">&#39;autoscaling_enabled&#39;</span><span class="p">:</span> <span class="n">autoscaling_enabled</span><span class="p">,</span>
        <span class="s1">&#39;max_replicas&#39;</span><span class="p">:</span> <span class="n">max_replicas</span><span class="p">,</span> <span class="s1">&#39;target_cpu_utilization&#39;</span><span class="p">:</span> <span class="n">target_cpu_utilization</span><span class="p">,</span>
        <span class="s1">&#39;disable_nginx&#39;</span><span class="p">:</span> <span class="n">disable_nginx</span><span class="p">,</span> <span class="s1">&#39;gunicorn_workers&#39;</span><span class="p">:</span> <span class="n">gunicorn_workers</span><span class="p">,</span>
        <span class="s1">&#39;resource_requests_enabled&#39;</span><span class="p">:</span> <span class="n">resource_requests_enabled</span><span class="p">,</span> <span class="s1">&#39;memory_limit&#39;</span><span class="p">:</span> <span class="n">memory_limit</span><span class="p">,</span>
        <span class="s1">&#39;resource_limits_enabled&#39;</span><span class="p">:</span> <span class="n">resource_limits_enabled</span><span class="p">,</span> <span class="s1">&#39;cpu_request&#39;</span><span class="p">:</span> <span class="n">cpu_request</span><span class="p">,</span> <span class="s1">&#39;cpu_limit&#39;</span><span class="p">:</span> <span class="n">cpu_limit</span><span class="p">,</span>
        <span class="s1">&#39;memory_request&#39;</span><span class="p">:</span> <span class="n">memory_request</span><span class="p">,</span> <span class="s1">&#39;expose_external&#39;</span><span class="p">:</span> <span class="n">expose_external</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="n">__initiate_job</span><span class="p">(</span><span class="n">payload</span><span class="p">,</span> <span class="s1">&#39;/api/rest/initiate&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="_undeploy_kubernetes"><a class="viewcode-back" href="../../../splicemachine.mlflow_support.html#splicemachine.mlflow_support.mlflow_support._undeploy_kubernetes">[docs]</a><span class="nd">@_mlflow_patch</span><span class="p">(</span><span class="s1">&#39;undeploy_kubernetes&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">_undeploy_kubernetes</span><span class="p">(</span><span class="n">run_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Removes a model deployment from Kubernetes. This will delete the Kubernetes deployment and record the event</span>

<span class="sd">    :param run_id: specified if overriding the active run</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Processing...&quot;</span><span class="p">)</span>

    <span class="n">payload</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;run_id&#39;</span><span class="p">:</span> <span class="n">run_id</span> <span class="ow">or</span> <span class="n">mlflow</span><span class="o">.</span><span class="n">active_run</span><span class="p">()</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">run_uuid</span><span class="p">,</span> <span class="s1">&#39;handler_name&#39;</span><span class="p">:</span> <span class="s1">&#39;UNDEPLOY_KUBERNETES&#39;</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="n">__initiate_job</span><span class="p">(</span><span class="n">payload</span><span class="p">,</span> <span class="s1">&#39;/api/rest/initiate&#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="_deploy_db"><a class="viewcode-back" href="../../../splicemachine.mlflow_support.html#splicemachine.mlflow_support.mlflow_support._deploy_db">[docs]</a><span class="nd">@_mlflow_patch</span><span class="p">(</span><span class="s1">&#39;deploy_database&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">_deploy_db</span><span class="p">(</span><span class="n">db_schema_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
               <span class="n">db_table_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
               <span class="n">run_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
               <span class="n">reference_table</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
               <span class="n">reference_schema</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
               <span class="n">primary_key</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
               <span class="n">df</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">SparkDF</span><span class="p">,</span> <span class="n">PandasDF</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
               <span class="n">create_model_table</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
               <span class="n">model_cols</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
               <span class="n">classes</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
               <span class="n">library_specific</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
               <span class="n">replace</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
               <span class="n">max_batch_size</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="mi">10000</span><span class="p">,</span>
               <span class="n">verbose</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Deploy a trained (currently Spark, Sklearn, Keras or H2O) model to the Database.</span>
<span class="sd">    This either creates a new table or alters an existing table in the database (depending on parameters passed)</span>

<span class="sd">    :param db_schema_name: (str) the schema name to deploy to.</span>
<span class="sd">    :param db_table_name: (str) the table name to deploy to.</span>
<span class="sd">    :param run_id: (str) The run_id to deploy the model on. The model associated with this run will be deployed</span>
<span class="sd">    :param reference_table: (str) if creating a new table, an alternative to specifying a dataframe is specifying a</span>
<span class="sd">        reference table. The column schema of the reference table will be used to create the new table (e.g. MYTABLE)\n</span>
<span class="sd">    :param reference_schema: (str) the db schema for the reference table.</span>
<span class="sd">    :param primary_key: (Dict) Dictionary of column + SQL datatype to use for the primary/composite key. \n</span>
<span class="sd">        * If you are deploying to a table that already exists, it must already have a primary key, and this parameter will be ignored. \n</span>
<span class="sd">        * If you are creating the table in this function, you MUST pass in a primary key</span>
<span class="sd">    :param df: (Spark or Pandas DF) The dataframe used to train the model \n</span>
<span class="sd">                | NOTE: The columns in this df are the ones that will be used to create the table unless specified by model_cols</span>
<span class="sd">    :param create_model_table: Whether or not to create the table from the dataframe. Default True. This</span>
<span class="sd">                                Will ONLY be used if the table does not exist and a dataframe is passed in</span>
<span class="sd">    :param model_cols: (List[str]) The columns from the table to use for the model. If None, all columns in the table</span>
<span class="sd">                                        will be passed to the model. If specified, the columns will be passed to the model</span>
<span class="sd">                                        IN THAT ORDER. The columns passed here must exist in the table.</span>
<span class="sd">    :param classes: (List[str]) The classes (prediction labels) for the model being deployed.\n</span>
<span class="sd">                    NOTE: If not supplied, the table will have default column names for each class</span>
<span class="sd">    :param library_specific: (dict{str: str}) Prediction options for certain model types: \n</span>
<span class="sd">        * Certain model types (specifically Keras and Scikit-learn) support prediction arguments. Here are the options that we support:</span>
<span class="sd">            * Scikit-learn</span>
<span class="sd">                * predict_call: determines function call for the model. Available: &#39;predict&#39; (default), &#39;predict_proba&#39;, &#39;transform&#39;</span>
<span class="sd">                * predict_args: passed into the predict call (for Gaussian and Bayesian models). Available: &#39;return_std&#39;, &#39;return_cov&#39;</span>
<span class="sd">            * Keras</span>
<span class="sd">                * pred_threshold: prediction threshold for Keras binary classification models. Note: If the model type is Keras, the output layer has 1 node, and pred_threshold is None, you will NOT receive a class prediction, only the output of the final layer (like model.predict()). If you want a class prediction for your binary classification problem, you MUST pass in a threshold.</span>
<span class="sd">    If the model does not support these parameters, they will be ignored.</span>
<span class="sd">    :param max_batch_size: (int) the max size for the database to batch groups of rows for prediction. Default 10,000.</span>
<span class="sd">    :param replace: (bool) whether or not to replace a currently existing model. This param is not yet implemented</span>
<span class="sd">    :return: None\n</span>

<span class="sd">    This function creates the following IF you are creating a table from the dataframe \n</span>
<span class="sd">        * The model table where run_id is the run_id passed in. This table will have a column for each feature in the feature vector. It will also contain:\n</span>
<span class="sd">            * USER which is the current user who made the request</span>
<span class="sd">            * EVAL_TIME which is the CURRENT_TIMESTAMP</span>
<span class="sd">            * the PRIMARY KEY column(s) passed in</span>
<span class="sd">            * PREDICTION. The prediction of the model. If the :classes: param is not filled in, this will be default values for classification models</span>
<span class="sd">            * A column for each class of the predictor with the value being the probability/confidence of the model if applicable\n</span>
<span class="sd">    IF you are deploying to an existing table, the table will be altered to include the columns above. \n</span>
<span class="sd">    :NOTE:</span>
<span class="sd">        .. code-block:: text</span>

<span class="sd">            The columns listed above are default value columns.\n</span>
<span class="sd">            This means that on a SQL insert into the table, \n</span>
<span class="sd">            you do not need to reference or insert values into them.\n</span>
<span class="sd">            They are automatically taken care of.\n</span>
<span class="sd">            Set verbose=True in the function call for more information</span>

<span class="sd">    The following will also be created for all deployments: \n</span>
<span class="sd">        * A trigger that runs on (after) insertion to the data table that runs an INSERT into the prediction table, \</span>
<span class="sd">            calling the PREDICT function, passing in the row of data as well as the schema of the dataset, and the run_id of the model to run \n</span>
<span class="sd">        * A trigger that runs on (after) insertion to the prediction table that calls an UPDATE to the row inserted, \</span>
<span class="sd">            parsing the prediction probabilities and filling in proper column values</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Deploying model to database...&quot;</span><span class="p">)</span>

    <span class="c1"># database converts all object names to upper case, so we need to as well in our metadata</span>
    <span class="n">db_schema_name</span><span class="o">=</span><span class="n">db_schema_name</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
    <span class="n">db_table_name</span><span class="o">=</span><span class="n">db_table_name</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>


    <span class="c1"># ~ Backwards Compatability ~</span>
    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Deprecated Parameter &#39;verbose&#39;. Use mlflow.watch_job(&lt;job id&gt;) or mlflow.fetch_logs(&lt;job id&gt;) to get&quot;</span>
              <span class="s2">&quot; verbose output. Ignoring...&quot;</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">stderr</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">primary_key</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">primary_key</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Passing in primary keys as a list of tuples is deprecated. Use dictionary {column name: type}&quot;</span><span class="p">,</span>
                  <span class="n">file</span><span class="o">=</span><span class="n">stderr</span><span class="p">)</span>
            <span class="n">primary_key</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">primary_key</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">df</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">PandasDF</span><span class="p">):</span>
            <span class="n">_check_for_splice_ctx</span><span class="p">()</span> <span class="c1"># We will need a splice context to convert to sparkDF</span>
            <span class="n">df_schema</span> <span class="o">=</span> <span class="n">mlflow</span><span class="o">.</span><span class="n">_splice_context</span><span class="o">.</span><span class="n">pandasToSpark</span><span class="p">(</span><span class="n">df</span><span class="p">)</span><span class="o">.</span><span class="n">schema</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">SparkDF</span><span class="p">):</span>
            <span class="n">df_schema</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">schema</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">SpliceMachineException</span><span class="p">(</span><span class="s2">&quot;Dataframe must either be a Pandas or Spark Dataframe&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">df_schema</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="n">payload</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;db_table&#39;</span><span class="p">:</span> <span class="n">db_table_name</span><span class="p">,</span> <span class="s1">&#39;db_schema&#39;</span><span class="p">:</span> <span class="n">db_schema_name</span><span class="p">,</span> <span class="s1">&#39;run_id&#39;</span><span class="p">:</span> <span class="n">run_id</span> <span class="ow">or</span> <span class="n">mlflow</span><span class="o">.</span><span class="n">active_run</span><span class="p">()</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">run_uuid</span><span class="p">,</span>
        <span class="s1">&#39;primary_key&#39;</span><span class="p">:</span> <span class="n">primary_key</span><span class="p">,</span> <span class="s1">&#39;df_schema&#39;</span><span class="p">:</span> <span class="n">df_schema</span><span class="p">,</span> <span class="s1">&#39;create_model_table&#39;</span><span class="p">:</span> <span class="n">create_model_table</span><span class="p">,</span>
        <span class="s1">&#39;model_cols&#39;</span><span class="p">:</span> <span class="n">model_cols</span><span class="p">,</span> <span class="s1">&#39;classes&#39;</span><span class="p">:</span> <span class="n">classes</span><span class="p">,</span> <span class="s1">&#39;library_specific&#39;</span><span class="p">:</span> <span class="n">library_specific</span><span class="p">,</span> <span class="s1">&#39;replace&#39;</span><span class="p">:</span> <span class="n">replace</span><span class="p">,</span>
        <span class="s1">&#39;handler_name&#39;</span><span class="p">:</span> <span class="s1">&#39;DEPLOY_DATABASE&#39;</span><span class="p">,</span> <span class="s1">&#39;reference_table&#39;</span><span class="p">:</span> <span class="n">reference_table</span><span class="p">,</span> <span class="s1">&#39;reference_schema&#39;</span><span class="p">:</span> <span class="n">reference_schema</span><span class="p">,</span> 
        <span class="s1">&#39;max_batch_size&#39;</span><span class="p">:</span> <span class="n">max_batch_size</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="n">__initiate_job</span><span class="p">(</span><span class="n">payload</span><span class="p">,</span> <span class="s1">&#39;/api/rest/initiate&#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="__get_logs"><a class="viewcode-back" href="../../../splicemachine.mlflow_support.html#splicemachine.mlflow_support.mlflow_support.__get_logs">[docs]</a><span class="k">def</span> <span class="nf">__get_logs</span><span class="p">(</span><span class="n">job_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Retrieve the logs associated with the specified job id</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">request</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">post</span><span class="p">(</span>
        <span class="n">get_pod_uri</span><span class="p">(</span><span class="s2">&quot;mlflow&quot;</span><span class="p">,</span> <span class="mi">5003</span><span class="p">,</span> <span class="n">_testing</span><span class="o">=</span><span class="n">_TESTING</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;/api/rest/logs&quot;</span><span class="p">,</span>
        <span class="n">json</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;task_id&quot;</span><span class="p">:</span> <span class="n">job_id</span><span class="p">},</span> <span class="n">auth</span><span class="o">=</span><span class="n">mlflow</span><span class="o">.</span><span class="n">_basic_auth</span>
    <span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">request</span><span class="o">.</span><span class="n">ok</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">SpliceMachineException</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Could not retrieve the logs for job </span><span class="si">{</span><span class="n">job_id</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">request</span><span class="o">.</span><span class="n">status_code</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">request</span><span class="o">.</span><span class="n">json</span><span class="p">()[</span><span class="s1">&#39;logs&#39;</span><span class="p">]</span></div>

<div class="viewcode-block" id="_watch_job"><a class="viewcode-back" href="../../../splicemachine.mlflow_support.html#splicemachine.mlflow_support.mlflow_support._watch_job">[docs]</a><span class="nd">@_mlflow_patch</span><span class="p">(</span><span class="s1">&#39;watch_job&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">_watch_job</span><span class="p">(</span><span class="n">job_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Stream the logs in real time to standard out</span>
<span class="sd">    of a Job</span>
<span class="sd">    :param job_id: the job id to watch (returned after executing an operation)</span>
<span class="sd">    NOTE: If the job being watched fails, this function will throw a SpliceMachineException</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">previous_lines</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">warn</span> <span class="o">=</span> <span class="kc">False</span> <span class="c1"># If there were any warnings from the log, we want to notify the user explicitly</span>
    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">logs_retrieved</span> <span class="o">=</span> <span class="n">__get_logs</span><span class="p">(</span><span class="n">job_id</span><span class="p">)</span>
        <span class="n">logs_retrieved</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="n">log_idx</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">logs_retrieved</span><span class="p">)</span>
        <span class="c1"># searching from the end is faster, because unless the logs double in the interval, it will be closer</span>
        <span class="k">for</span> <span class="n">log_idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">logs_retrieved</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">logs_retrieved</span><span class="p">[</span><span class="n">log_idx</span><span class="p">]</span> <span class="ow">in</span> <span class="n">previous_lines</span><span class="p">:</span>
                <span class="k">break</span>

        <span class="n">idx</span> <span class="o">=</span> <span class="n">log_idx</span><span class="o">+</span><span class="mi">1</span> <span class="k">if</span> <span class="n">log_idx</span> <span class="k">else</span> <span class="n">log_idx</span> <span class="c1"># First time getting logs, go to 0th index, else log_idx+1</span>
        <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">logs_retrieved</span><span class="p">[</span><span class="n">idx</span><span class="p">:]:</span>
            <span class="k">if</span> <span class="s1">&#39;WARNING&#39;</span> <span class="ow">in</span> <span class="n">n</span><span class="p">:</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
                <span class="n">warn</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="se">\n</span><span class="si">{</span><span class="n">n</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span><span class="n">end</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>

        <span class="n">previous_lines</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">logs_retrieved</span><span class="p">)</span>  <span class="c1"># O(1) checking</span>
        <span class="n">previous_lines</span> <span class="o">=</span> <span class="n">previous_lines</span> <span class="k">if</span> <span class="n">previous_lines</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="k">else</span> <span class="n">previous_lines</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="c1"># Remove empty line</span>
        <span class="k">if</span> <span class="s1">&#39;TASK_COMPLETED&#39;</span> <span class="ow">in</span> <span class="n">previous_lines</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span> <span class="c1"># Finishing Statement</span>
            <span class="c1"># Check for a failure first, and raise an error if so</span>
            <span class="k">for</span> <span class="n">log</span> <span class="ow">in</span> <span class="nb">reversed</span><span class="p">(</span><span class="n">previous_lines</span><span class="p">):</span>
                <span class="k">if</span> <span class="s1">&#39;ERROR&#39;</span> <span class="ow">in</span> <span class="n">log</span> <span class="ow">and</span> <span class="s1">&#39;Task Failed&#39;</span> <span class="ow">in</span> <span class="n">log</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">SpliceMachineException</span><span class="p">(</span>
                        <span class="s1">&#39;An error occured in your Job. See the log above for more information&#39;</span>
                    <span class="p">)</span> <span class="kn">from</span> <span class="bp">None</span>
            <span class="k">if</span> <span class="n">warn</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span><span class="s1">&#39;Note! Your deployment had some warnings you should consider.&#39;</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span></div>


<div class="viewcode-block" id="_fetch_logs"><a class="viewcode-back" href="../../../splicemachine.mlflow_support.html#splicemachine.mlflow_support.mlflow_support._fetch_logs">[docs]</a><span class="nd">@_mlflow_patch</span><span class="p">(</span><span class="s1">&#39;fetch_logs&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">_fetch_logs</span><span class="p">(</span><span class="n">job_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get the logs as an array</span>
<span class="sd">    :param job_id: the job to get the logs for</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">__get_logs</span><span class="p">(</span><span class="n">job_id</span><span class="p">)</span></div>


<div class="viewcode-block" id="_get_deployed_models"><a class="viewcode-back" href="../../../splicemachine.mlflow_support.html#splicemachine.mlflow_support.mlflow_support._get_deployed_models">[docs]</a><span class="nd">@_mlflow_patch</span><span class="p">(</span><span class="s1">&#39;get_deployed_models&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">_get_deployed_models</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">PandasDF</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get the currently deployed models in the database</span>
<span class="sd">    :return: Pandas df</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">return</span> <span class="n">mlflow</span><span class="o">.</span><span class="n">_splice_context</span><span class="o">.</span><span class="n">df</span><span class="p">(</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        SELECT * FROM MLMANAGER.LIVE_MODEL_STATUS</span>
<span class="sd">        &quot;&quot;&quot;</span>
    <span class="p">)</span><span class="o">.</span><span class="n">toPandas</span><span class="p">()</span></div>


<span class="k">def</span> <span class="nf">apply_patches</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Apply all the Gorilla Patches; \</span>
<span class="sd">    All Gorilla Patched MUST be predixed with &#39;_&#39; before their destination in MLflow</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">targets</span> <span class="o">=</span> <span class="p">[</span><span class="n">_register_feature_store</span><span class="p">,</span> <span class="n">_register_splice_context</span><span class="p">,</span> <span class="n">_lp</span><span class="p">,</span> <span class="n">_lm</span><span class="p">,</span> <span class="n">_timer</span><span class="p">,</span> <span class="n">_log_artifact</span><span class="p">,</span> <span class="n">_log_feature_transformations</span><span class="p">,</span>
               <span class="n">_log_model_params</span><span class="p">,</span> <span class="n">_log_pipeline_stages</span><span class="p">,</span> <span class="n">_log_model</span><span class="p">,</span> <span class="n">_load_model</span><span class="p">,</span> <span class="n">_download_artifact</span><span class="p">,</span>
               <span class="n">_start_run</span><span class="p">,</span> <span class="n">_current_run_id</span><span class="p">,</span> <span class="n">_current_exp_id</span><span class="p">,</span> <span class="n">_deploy_aws</span><span class="p">,</span> <span class="n">_deploy_azure</span><span class="p">,</span> <span class="n">_deploy_db</span><span class="p">,</span> <span class="n">_login_director</span><span class="p">,</span>
               <span class="n">_get_run_ids_by_name</span><span class="p">,</span> <span class="n">_get_deployed_models</span><span class="p">,</span> <span class="n">_deploy_kubernetes</span><span class="p">,</span> <span class="n">_undeploy_kubernetes</span><span class="p">,</span> <span class="n">_fetch_logs</span><span class="p">,</span>
               <span class="n">_watch_job</span><span class="p">,</span> <span class="n">_end_run</span><span class="p">,</span> <span class="n">_set_mlflow_uri</span><span class="p">,</span> <span class="n">_remove_active_training_set</span><span class="p">]</span>

    <span class="k">for</span> <span class="n">target</span> <span class="ow">in</span> <span class="n">targets</span><span class="p">:</span>
        <span class="n">gorilla</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">gorilla</span><span class="o">.</span><span class="n">Patch</span><span class="p">(</span><span class="n">mlflow</span><span class="p">,</span> <span class="n">target</span><span class="o">.</span><span class="vm">__name__</span><span class="o">.</span><span class="n">lstrip</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">),</span> <span class="n">target</span><span class="p">,</span> <span class="n">settings</span><span class="o">=</span><span class="n">_GORILLA_SETTINGS</span><span class="p">))</span>


<div class="viewcode-block" id="_set_mlflow_uri"><a class="viewcode-back" href="../../../splicemachine.mlflow_support.html#splicemachine.mlflow_support.mlflow_support._set_mlflow_uri">[docs]</a><span class="k">def</span> <span class="nf">_set_mlflow_uri</span><span class="p">(</span><span class="n">uri</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Set the tracking uri for mlflow. Only needed if running outside of the Splice Machine K8s Cloud Service</span>

<span class="sd">    :param uri: (str) the URL of your mlflow UI.</span>
<span class="sd">    :return: None</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">_CLIENT</span> <span class="o">=</span> <span class="n">mlflow</span><span class="o">.</span><span class="n">tracking</span><span class="o">.</span><span class="n">MlflowClient</span><span class="p">(</span><span class="n">tracking_uri</span><span class="o">=</span><span class="n">uri</span><span class="p">)</span>
    <span class="n">mlflow</span><span class="o">.</span><span class="n">client</span> <span class="o">=</span> <span class="n">_CLIENT</span>
    <span class="n">mlflow</span><span class="o">.</span><span class="n">set_tracking_uri</span><span class="p">(</span><span class="n">uri</span><span class="p">)</span></div>


<span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="n">mlflow</span><span class="o">.</span><span class="n">set_tracking_uri</span><span class="p">(</span><span class="n">_TRACKING_URL</span><span class="p">)</span>
    <span class="n">apply_patches</span><span class="p">()</span>
    <span class="n">__try_auto_login</span><span class="p">()</span>


<span class="n">main</span><span class="p">()</span>
</pre></div>

              </div>
              
        
        <div class='prev-next-bottom'>
            

        </div>
        
        </div>
    </div>
    <footer class="footer mt-5 mt-md-0">
    <div class="container">
      <p>
        
          By Ben Epstein<br/>
        
            &copy; Copyright 2020, Splice Machine.<br/>
      </p>
    </div>
  </footer>
</main>


      </div>
    </div>
  
  <script src="../../../_static/js/index.1c5a1a01449ed65a7b51.js"></script>

  
  </body>
</html>